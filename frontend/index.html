<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Analytics Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <script>
        // Check for saved theme or default to dark
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark')
        } else {
            document.documentElement.classList.remove('dark')
        }
    </script>
</head>

<body class="antialiased">
    <!-- Navigation Header -->
    <nav class="bg-white shadow-sm border-b border-gray-100">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo and Brand -->
                <div class="flex items-center space-x-3">
                    <div
                        class="w-10 h-10 bg-gradient-to-br from-blue-600 to-blue-700 rounded-lg flex items-center justify-center">
                        <i class="fas fa-chart-line text-white text-lg"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-gray-900">Portfolio Analytics</h1>
                        <p class="text-xs text-gray-500">Professional Investment Dashboard</p>
                    </div>
                </div>

                <!-- Navigation Menu -->
                <div class="flex items-center space-x-6">
                    <button class="text-gray-600 hover:text-blue-600 transition-colors">
                        <i class="fas fa-bell text-lg"></i>
                    </button>
                    <button class="text-gray-600 hover:text-blue-600 transition-colors">
                        <i class="fas fa-cog text-lg"></i>
                    </button>
                    <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-user text-blue-600 text-sm"></i>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Toast Container -->
    <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="mb-8">
            <div class="flex space-x-8 border-b border-gray-200">
                <button class="tab-button px-4 py-2 font-medium text-blue-600 border-b-2 border-blue-600"
                    data-tab="builder">
                    Portfolio Builder
                </button>
                <button
                    class="tab-button px-4 py-2 font-medium text-gray-500 hover:text-gray-700 border-b-2 border-transparent"
                    data-tab="dashboard">
                    Current Portfolio
                </button>
                <button
                    class="tab-button px-4 py-2 font-medium text-gray-500 hover:text-gray-700 border-b-2 border-transparent"
                    data-tab="analytics">
                    Analytics
                </button>
            </div>
        </div>

        <!-- Builder Tab -->
        <div id="builder-tab" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <!-- Left Panel: Builder Controls (4 cols) -->
                <div class="lg:col-span-4 space-y-6">
                    <!-- Asset Search - Enhanced -->
                    <div
                        class="bg-gradient-to-br from-blue-50 to-white rounded-xl shadow-sm p-6 relative overflow-visible border border-blue-100 hover:shadow-md transition-shadow">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                            <i class="fas fa-search-dollar text-blue-600 mr-2"></i>
                            Add Assets
                        </h3>
                        <div class="flex space-x-2">
                            <div class="relative flex-1">
                                <input type="text" id="assetSearch"
                                    class="w-full pl-10 pr-10 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
                                    placeholder="Search symbol (e.g. AAPL)..." autocomplete="off">
                                <div id="searchIcon" class="absolute left-3 top-3.5 text-gray-400 transition-all">
                                    <i class="fas fa-search"></i>
                                </div>
                                <div id="searchSpinner" class="absolute right-3 top-3.5 text-blue-500 hidden">
                                    <i class="fas fa-spinner fa-spin"></i>
                                </div>
                                <!-- Search Results Dropdown - Enhanced -->
                                <div id="searchResults"
                                    class="absolute z-50 w-full mt-2 bg-white border border-gray-200 rounded-lg shadow-2xl hidden animate-fadeIn"
                                    style="max-height: 300px; overflow-y: auto;">
                                    <!-- Results injected here -->
                                </div>
                            </div>
                            <button id="manualAddBtn"
                                class="px-6 py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg hover:from-blue-700 hover:to-blue-800 transition-all transform hover:scale-105 hover:shadow-lg active:scale-95 font-medium">
                                <i class="fas fa-plus mr-1"></i> Add
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">
                            <i class="fas fa-lightbulb text-yellow-500 mr-1"></i>
                            Tip: Type a symbol and press Enter or click Add
                        </p>
                    </div>

                    <!-- Holdings List - Enhanced -->
                    <div id="holdingsCard"
                        class="bg-white rounded-xl shadow-sm p-6 border border-gray-100 hover:shadow-md transition-shadow">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                                <i class="fas fa-briefcase text-gray-600 mr-2"></i>
                                Proposed Holdings
                                <span id="holdingsCount"
                                    class="ml-2 px-2 py-0.5 bg-blue-100 text-blue-700 text-xs rounded-full">0</span>
                            </h3>
                            <span id="totalWeight" class="text-sm font-medium text-gray-500">Total: 0%</span>
                        </div>
                        <div id="builderHoldingsList" class="space-y-3 max-h-[600px] overflow-y-auto custom-scrollbar">
                            <!-- Holdings injected here -->
                            <div id="emptyHoldingsState" class="text-center py-12">
                                <div class="inline-block p-4 rounded-full bg-gray-100 mb-3">
                                    <i class="fas fa-folder-open text-4xl text-gray-400"></i>
                                </div>
                                <p class="text-gray-500 mb-2">No assets added yet</p>
                                <p class="text-sm text-gray-400">Search for stocks above to start building your
                                    portfolio</p>
                            </div>
                        </div>
                        <div class="mt-6 pt-4 border-t border-gray-100">
                            <button id="simulateBtn"
                                class="w-full bg-gradient-to-r from-green-600 to-green-700 text-white px-4 py-3 rounded-lg hover:from-green-700 hover:to-green-800 transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:from-gray-400 disabled:to-gray-500 transform hover:scale-[1.02] active:scale-95 font-medium shadow-md"
                                disabled>
                                <i class="fas fa-chart-line mr-2"></i>Analyze Portfolio
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Right Panel: Real-time Preview (8 cols) -->
                <div class="lg:col-span-8 space-y-6">
                    <!-- Summary Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-white rounded-xl shadow-sm p-6">
                            <div class="flex items-center">
                                <div class="p-3 rounded-full bg-green-100 text-green-600">
                                    <i class="fas fa-chart-line text-xl"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-500">Est. Return (1Y)</p>
                                    <h3 class="text-xl font-bold text-gray-900" id="previewReturn">-</h3>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl shadow-sm p-6">
                            <div class="flex items-center">
                                <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                                    <i class="fas fa-shield-alt text-xl"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-500">Risk (Vol)</p>
                                    <h3 class="text-xl font-bold text-gray-900" id="previewRisk">-</h3>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl shadow-sm p-6">
                            <div class="flex items-center">
                                <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                                    <i class="fas fa-coins text-xl"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-500">Est. Yield</p>
                                    <h3 class="text-xl font-bold text-gray-900" id="previewYield">-</h3>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Charts Area -->
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Projected Performance</h3>
                        <div class="chart-container relative h-80 w-full">
                            <canvas id="builderPreviewChart"></canvas>
                        </div>
                    </div>

                    <!-- Advanced Metrics Preview -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white rounded-xl shadow-sm p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Asset Allocation</h3>
                            <div class="chart-container relative h-64 w-full">
                                <canvas id="builderAllocationChart"></canvas>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl shadow-sm p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Risk Analysis</h3>
                            <div id="builderRiskStats" class="space-y-3">
                                <!-- Risk stats injected here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard Tab (Existing) -->
        <div id="dashboard-tab" class="tab-content hidden">
            <!-- Upload Section -->
            <div id="uploadSection" class="max-w-2xl mx-auto">
                <div class="bg-white rounded-xl shadow-lg p-8">
                    <div class="text-center mb-6">
                        <i class="fas fa-cloud-upload-alt text-6xl text-blue-600 mb-4"></i>
                        <h2 class="text-2xl font-bold text-gray-900 mb-2">Upload Portfolio File</h2>
                        <p class="text-gray-600">Drag and drop your CSV or Excel file, or click to browse</p>
                    </div>

                    <div id="dropArea" class="upload-area rounded-lg p-12 text-center cursor-pointer">
                        <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" class="hidden">
                        <i class="fas fa-file-upload text-4xl text-gray-400 mb-3"></i>
                        <p class="text-gray-600 font-medium">Click to select file</p>
                        <p class="text-sm text-gray-500 mt-2">Supports CSV, XLSX, XLS</p>
                    </div>

                    <div id="uploadStatus" class="mt-4 hidden">
                        <div class="flex items-center justify-center">
                            <div class="loading mr-3"></div>
                            <span class="text-gray-700">Processing your portfolio...</span>
                        </div>
                    </div>

                    <div id="uploadError" class="mt-4 hidden bg-red-50 border border-red-200 rounded-lg p-4">
                        <div class="flex items-center">
                            <i class="fas fa-exclamation-circle text-red-500 mr-3"></i>
                            <span class="text-red-700" id="errorMessage"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dashboard Section -->
            <div id="dashboardSection" class="hidden">
                <!-- Wealth Overview -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="glass-panel p-6">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-sm font-medium text-gray-400">Net Worth</h3>
                            <i class="fas fa-gem text-purple-500"></i>
                        </div>
                        <p class="text-4xl font-bold text-white bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-500"
                            id="netWorthValue">$0.00</p>
                    </div>
                    <div class="glass-panel p-6">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-sm font-medium text-gray-400">Total Assets</h3>
                            <i class="fas fa-arrow-up text-green-500"></i>
                        </div>
                        <p class="text-2xl font-bold text-green-400" id="totalAssetsValue">$0.00</p>
                    </div>
                    <div class="glass-panel p-6">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-sm font-medium text-gray-400">Total Liabilities</h3>
                            <i class="fas fa-arrow-down text-red-500"></i>
                        </div>
                        <p class="text-2xl font-bold text-red-400" id="totalLiabilitiesValue">$0.00</p>
                    </div>
                </div>

                <!-- Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <!-- Total Value Card -->
                    <div class="bg-white rounded-xl shadow-lg p-6 metric-card">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-sm font-medium text-gray-600">Total Value</h3>
                            <i class="fas fa-wallet text-blue-600"></i>
                        </div>
                        <p class="text-3xl font-bold text-gray-900" id="totalValue">$0.00</p>
                        <div class="mt-2 flex items-center text-sm" id="dailyChange">
                            <span class="text-gray-600">Today: </span>
                        </div>
                    </div>

                    <!-- Total Gain/Loss Card -->
                    <div class="bg-white rounded-xl shadow-lg p-6 metric-card">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-sm font-medium text-gray-600">Total Gain/Loss</h3>
                            <i class="fas fa-chart-line text-green-600"></i>
                        </div>
                        <p class="text-3xl font-bold" id="totalGainLoss">$0.00</p>
                        <div class="mt-2 flex items-center text-sm" id="returnPct">
                            <span class="text-gray-600">Return: </span>
                        </div>
                    </div>

                    <!-- Annual Income Card -->
                    <div class="bg-white rounded-xl shadow-lg p-6 metric-card">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-sm font-medium text-gray-600">Annual Income</h3>
                            <i class="fas fa-dollar-sign text-purple-600"></i>
                        </div>
                        <p class="text-3xl font-bold text-gray-900" id="annualIncome">$0.00</p>
                        <div class="mt-2 flex items-center text-sm" id="avgYield">
                            <span class="text-gray-600">Avg Yield: </span>
                        </div>
                    </div>

                    <!-- Holdings Count Card -->
                    <div class="bg-white rounded-xl shadow-lg p-6 metric-card">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-sm font-medium text-gray-600">Holdings</h3>
                            <i class="fas fa-list text-orange-600"></i>
                        </div>
                        <p class="text-3xl font-bold text-gray-900" id="holdingsCount">0</p>
                        <div class="mt-2 flex items-center text-sm">
                            <span class="text-gray-600" id="principalAmount">Principal: $0</span>
                        </div>
                    </div>
                </div>

                <!-- Portfolio Analysis Section (NEW) -->
                <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                        <i class="fas fa-chart-line text-blue-600 mr-2"></i>
                        ðŸ“Š Portfolio Analysis & Insights
                    </h3>
                    <div id="portfolioAnalysisText" class="space-y-3 text-gray-700 leading-relaxed">
                        <div class="text-center py-8 text-gray-400">
                            <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                            <p>Analyzing your portfolio data...</p>
                        </div>
                    </div>
                </div>

                <!-- Benchmarking Chart (New) -->
                <div class="glass-panel p-6 mb-8">
                    <h3 class="text-xl font-bold mb-4 text-white">Portfolio Performance vs S&P 500 (1Y Backtest)</h3>
                    <div class="h-80">
                        <canvas id="benchmarkChart"></canvas>
                    </div>
                    <div id="benchmarkMetrics" class="grid grid-cols-3 gap-4 mt-4 text-center">
                        <!-- Metrics injected here -->
                    </div>
                </div>

                <!-- Dividend Calendar (New) -->
                <div class="glass-panel p-6 mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-white">Projected Dividend Income</h3>
                        <div class="text-right">
                            <div class="text-xs text-gray-400">Next 12 Months</div>
                            <div class="text-green-400 font-bold text-lg" id="totalProjectedIncome">$0.00</div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="h-64">
                            <canvas id="dividendChart"></canvas>
                        </div>
                        <div class="overflow-y-auto h-64 custom-scrollbar">
                            <table class="w-full text-left text-sm text-gray-300">
                                <thead class="text-gray-500 border-b border-gray-700">
                                    <tr>
                                        <th class="pb-2">Date</th>
                                        <th class="pb-2">Symbol</th>
                                        <th class="pb-2 text-right">Est. Amount</th>
                                    </tr>
                                </thead>
                                <tbody id="dividendList" class="divide-y divide-gray-800">
                                    <!-- Rows injected here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Charts Section -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <!-- Allocation by Symbol -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Portfolio Allocation</h3>
                        <div class="chart-container">
                            <canvas id="allocationChart"></canvas>
                        </div>
                    </div>

                    <!-- Asset Class Distribution -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-gray-500 text-sm font-medium mb-4">Asset Allocation</h3>
                        <div class="h-64">
                            <canvas id="assetAllocationChart"></canvas>
                        </div>
                    </div>

                    <!-- Sector Allocation (New) -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-gray-500 text-sm font-medium mb-4">Sector Exposure</h3>
                        <div class="h-64 relative flex items-center justify-center">
                            <canvas id="sectorAllocationChart"></canvas>
                            <div id="sectorLoader"
                                class="absolute inset-0 flex items-center justify-center bg-white bg-opacity-80 hidden">
                                <i class="fas fa-spinner fa-spin text-blue-600 text-2xl"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Risk & Analytics Dash (New) -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <!-- Risk Card -->
                    <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-red-500">
                        <h3 class="text-gray-500 text-sm font-medium mb-2">Risk Profile</h3>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Beta (vs SPY)</span>
                                <span id="metricBeta" class="font-bold text-gray-900 text-lg">--</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-1.5">
                                <div id="barBeta" class="bg-red-500 h-1.5 rounded-full" style="width: 0%"></div>
                            </div>

                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Sharpe Ratio</span>
                                <span id="metricSharpe" class="font-bold text-gray-900 text-lg">--</span>
                            </div>

                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Volatility (1Y)</span>
                                <span id="metricVol" class="font-bold text-gray-900 text-lg">--</span>
                            </div>
                        </div>
                    </div>

                    <!-- Top Sectors List -->
                    <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-blue-500 col-span-2">
                        <h3 class="text-gray-500 text-sm font-medium mb-2">Top Sectors Detail</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full text-sm text-left text-gray-500">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2">Sector</th>
                                        <th class="px-4 py-2">Value</th>
                                        <th class="px-4 py-2">%</th>
                                    </tr>
                                </thead>
                                <tbody id="sectorTable" class="divide-y divide-gray-100">
                                    <!-- Rows -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <!-- Allocation by Asset Type -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Asset Type Distribution</h3>
                    <div class="chart-container">
                        <canvas id="assetTypeChart"></canvas>
                    </div>
                </div>

                <!-- Gain/Loss by Symbol -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Top Gainers & Losers</h3>
                    <div class="chart-container">
                        <canvas id="gainLossChart"></canvas>
                    </div>
                </div>

                <!-- Daily Movement -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Daily Price Movement</h3>
                    <div class="chart-container">
                        <canvas id="dailyMovementChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- News Section (New) -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <!-- Wealth Assistant Chat Widget -->
                <div class="chat-widget flex flex-col items-end">
                    <!-- Chat Window -->
                    <div id="chatWindow"
                        class="chat-window bg-white w-80 md:w-96 h-[500px] rounded-2xl shadow-2xl mb-4 flex flex-col overflow-hidden border border-gray-100">
                        <!-- Header -->
                        <div
                            class="bg-gradient-to-r from-blue-600 to-indigo-600 p-4 text-white flex justify-between items-center">
                            <div class="flex items-center space-x-2">
                                <div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center">
                                    <i class="fas fa-robot text-sm"></i>
                                </div>
                                <div>
                                    <h3 class="font-semibold text-sm">VisionWealth AI</h3>
                                    <p class="text-xs text-blue-100">Your Personal Analyst</p>
                                </div>
                            </div>
                            <button onclick="toggleChat()" class="text-white/80 hover:text-white"><i
                                    class="fas fa-times"></i></button>
                        </div>

                        <!-- Messages -->
                        <div id="chatMessages" class="flex-1 p-4 overflow-y-auto bg-gray-50 space-y-4 custom-scrollbar">
                            <!-- Welcome Message -->
                            <div class="flex items-start space-x-2">
                                <div
                                    class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0 text-blue-600">
                                    <i class="fas fa-robot text-xs"></i>
                                </div>
                                <div
                                    class="bg-white p-3 rounded-2xl rounded-tl-none shadow-sm text-sm text-gray-700 border border-gray-100">
                                    Hello! I analyze your portfolio in real-time. Ask me about your dividends, risk
                                    exposure, or net worth.
                                </div>
                            </div>
                        </div>

                        <!-- Input -->
                        <div class="p-3 bg-white border-t border-gray-100">
                            <div class="flex items-center bg-gray-100 rounded-full px-4 py-2">
                                <input type="text" id="chatInput" placeholder="Ask anything..."
                                    class="bg-transparent flex-1 text-sm outline-none text-gray-700"
                                    onkeypress="handleChatKey(event)">
                                <button onclick="sendMessage()" class="ml-2 text-blue-600 hover:text-blue-700"><i
                                        class="fas fa-paper-plane"></i></button>
                            </div>
                        </div>
                    </div>

                    <!-- Toggle Button -->
                    <button onclick="toggleChat()"
                        class="bg-blue-600 hover:bg-blue-700 text-white rounded-full w-14 h-14 shadow-lg flex items-center justify-center transition hover:scale-105 active:scale-95">
                        <i class="fas fa-comment-dots text-2xl"></i>
                    </button>
                </div>

                <!-- Scripts -->
                <!-- Watchlist -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">Watchlist</h3>
                        <div class="flex space-x-2">
                            <input type="text" id="watchlistInput" placeholder="Symbol"
                                class="w-24 px-2 py-1 border rounded text-sm">
                            <button id="addToWatchlistBtn"
                                class="px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700">Add</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto max-h-96 overflow-y-auto custom-scrollbar">
                        <table class="min-w-full text-left text-sm">
                            <thead class="text-gray-500 border-b border-gray-200">
                                <tr>
                                    <th class="py-2">Symbol</th>
                                    <th class="py-2">Price</th>
                                    <th class="py-2 text-right">Action</th>
                                </tr>
                            </thead>
                            <tbody id="watchlistBody" class="divide-y divide-gray-100">
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Market News -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">Market News</h3>
                        <button id="refreshNewsBtn" class="text-blue-600 hover:text-blue-800 text-sm"><i
                                class="fas fa-sync-alt"></i></button>
                    </div>
                    <div id="newsFeed" class="space-y-4 max-h-96 overflow-y-auto custom-scrollbar pr-2">
                        <!-- News Items -->
                        <div class="text-center text-gray-500 py-4">Loading news...</div>
                    </div>
                </div>
            </div>

            <!-- Holdings Table -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">Portfolio Holdings</h3>
                    <div class="flex items-center space-x-4">
                        <input type="text" id="searchInput" placeholder="Search holdings..."
                            class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <button id="refreshPricesBtn" title="Refresh live prices"
                            class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">
                            <i class="fas fa-sync-alt mr-2"></i>Refresh Prices
                        </button>
                        <label class="flex items-center space-x-2 text-sm text-gray-600 ml-2">
                            <input id="autoRefreshToggle" type="checkbox" class="w-4 h-4" />
                            <span>Auto-refresh (10s)</span>
                        </label>
                        <button id="addAssetBtn"
                            class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition hidden">
                            <i class="fas fa-plus mr-2"></i>Add Asset
                        </button>
                        <span id="lastRefreshed" class="text-xs text-gray-500 ml-2">Last refreshed: â€”</span>
                        <button id="exportBtn"
                            class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
                            <i class="fas fa-download mr-2"></i>Export CSV
                        </button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th
                                    class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                                    Symbol</th>
                                <th
                                    class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">
                                    Description</th>
                                <th
                                    class="px-4 py-3 text-right text-xs font-medium text-gray-700 uppercase tracking-wider">
                                    Quantity</th>
                                <th
                                    class="px-4 py-3 text-right text-xs font-medium text-gray-700 uppercase tracking-wider">
                                    Price</th>
                                <th
                                    class="px-4 py-3 text-right text-xs font-medium text-gray-700 uppercase tracking-wider">
                                    Value</th>
                                <th
                                    class="px-4 py-3 text-right text-xs font-medium text-gray-700 uppercase tracking-wider">
                                    Gain/Loss</th>
                                <th
                                    class="px-4 py-3 text-right text-xs font-medium text-gray-700 uppercase tracking-wider">
                                    Return %</th>
                                <th
                                    class="px-4 py-3 text-right text-xs font-medium text-gray-700 uppercase tracking-wider">
                                    Yield %</th>
                            </tr>
                        </thead>
                        <tbody id="holdingsTableBody" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        </div>

        <!-- Analytics Tab -->
        <div id="analytics-tab" class="tab-content hidden">
            <!-- Advanced Analytics Tabs -->
            <div class="bg-white rounded-xl shadow-lg p-6 mt-8">
                <div class="border-b border-gray-200 mb-6">
                    <nav class="-mb-px flex space-x-8">
                        <button
                            class="analytics-tab active py-4 px-1 border-b-2 border-blue-600 font-semibold text-blue-600"
                            data-tab="risk">
                            <i class="fas fa-shield-alt mr-2"></i>Risk Analysis
                        </button>
                        <button
                            class="analytics-tab py-4 px-1 border-b-2 border-transparent font-semibold text-gray-500 hover:text-gray-700 hover:border-gray-300"
                            data-tab="recommendations">
                            <i class="fas fa-lightbulb mr-2"></i>Recommendations
                        </button>
                        <button
                            class="analytics-tab py-4 px-1 border-b-2 border-transparent font-semibold text-gray-500 hover:text-gray-700 hover:border-gray-300"
                            data-tab="sectors">
                            <i class="fas fa-chart-pie mr-2"></i>Sector Analysis
                        </button>
                        <button
                            class="analytics-tab py-4 px-1 border-b-2 border-transparent font-semibold text-gray-500 hover:text-gray-700 hover:border-gray-300"
                            data-tab="performance">
                            <i class="fas fa-chart-line mr-2"></i>Performance Analysis
                        </button>
                        <button
                            class="analytics-tab py-4 px-1 border-b-2 border-transparent font-semibold text-gray-500 hover:text-gray-700 hover:border-gray-300"
                            data-tab="advanced-risk">
                            <i class="fas fa-shield-alt mr-2"></i>Advanced Risk
                        </button>
                        <button
                            class="analytics-tab py-4 px-1 border-b-2 border-transparent font-semibold text-gray-500 hover:text-gray-700 hover:border-gray-300"
                            data-tab="dividends">
                            <i class="fas fa-dollar-sign mr-2"></i>Dividend Metrics
                        </button>
                    </nav>
                </div>

                <!-- Risk Analysis Tab -->
                <div id="tab-risk" class="analytics-tab-content">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div class="bg-gradient-to-br from-red-50 to-red-100 rounded-lg p-5">
                            <h4 class="text-sm font-medium text-gray-600 mb-2">Value at Risk (95%)</h4>
                            <p class="text-2xl font-bold text-red-700" id="var95">$0.00</p>
                            <p class="text-xs text-gray-600 mt-1">Maximum potential loss</p>
                        </div>
                        <div class="bg-gradient-to-br from-orange-50 to-orange-100 rounded-lg p-5">
                            <h4 class="text-sm font-medium text-gray-600 mb-2">Portfolio Volatility</h4>
                            <p class="text-2xl font-bold text-orange-700" id="volatility">0.00%</p>
                            <p class="text-xs text-gray-600 mt-1">Annualized std dev</p>
                        </div>
                        <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg p-5">
                            <h4 class="text-sm font-medium text-gray-600 mb-2">Diversification Score</h4>
                            <p class="text-2xl font-bold text-purple-700" id="diversificationScore">0</p>
                            <p class="text-xs text-gray-600 mt-1" id="concentrationRisk">-</p>
                        </div>
                    </div>

                    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4" id="taxOpportunities">
                        <h4 class="text-sm font-semibold text-yellow-800 mb-2">Tax Loss Harvesting Opportunities</h4>
                        <div id="taxList" class="text-sm text-yellow-700">No opportunities detected</div>
                    </div>
                </div>

                <!-- Recommendations Tab -->
                <div id="tab-recommendations" class="analytics-tab-content hidden">
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Risk Profile</label>
                        <select id="riskProfile"
                            class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="conservative">Conservative</option>
                            <option value="moderate" selected>Moderate</option>
                            <option value="aggressive">Aggressive</option>
                        </select>
                    </div>
                    <div id="recommendationsList" class="space-y-4">
                        <p class="text-gray-500">Loading recommendations...</p>
                    </div>
                </div>

                <!-- Sectors Tab -->
                <div id="tab-sectors" class="analytics-tab-content hidden">
                    <div class="chart-container" style="height: 400px;">
                        <div class="chart-container" style="height: 400px;">
                            <canvas id="sectorDetailChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Dividends Tab -->
                <div id="tab-dividends" class="analytics-tab-content hidden">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-lg p-5">
                            <h4 class="text-sm font-medium text-gray-600 mb-2">Monthly Income</h4>
                            <p class="text-2xl font-bold text-green-700" id="monthlyIncome">$0.00</p>
                        </div>
                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-5">
                            <h4 class="text-sm font-medium text-gray-600 mb-2">Quarterly Income</h4>
                            <p class="text-2xl font-bold text-blue-700" id="quarterlyIncome">$0.00</p>
                        </div>
                        <div class="bg-gradient-to-br from-indigo-50 to-indigo-100 rounded-lg p-5">
                            <h4 class="text-sm font-medium text-gray-600 mb-2">Div. Paying Stocks</h4>
                            <p class="text-2xl font-bold text-indigo-700" id="divStocksCount">0</p>
                        </div>
                    </div>
                    <div id="topDividendPayers" class="overflow-hidden"></div>
                </div>
            </div>
        </div>
        </div>

        <!-- Portfolio Modal -->
        <div id="portfolioModal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center z-50">
            <div class="bg-white rounded-lg w-11/12 max-w-2xl p-6 shadow-lg">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold">Saved Portfolios</h3>
                    <button id="closePortfolioModal" class="text-gray-500 hover:text-gray-800">âœ•</button>
                </div>
                <div id="portfolioList" class="space-y-3 max-h-72 overflow-y-auto">
                    <!-- Portfolio items will be injected here -->
                </div>
                <div class="mt-4 flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <label class="flex items-center space-x-2 text-sm text-gray-700">
                            <input id="loadFetchLive" type="checkbox" class="w-4 h-4" checked />
                            <span>Fetch live prices when loading</span>
                        </label>
                    </div>
                    <div class="text-right">
                        <button id="refreshPortfolioList"
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 mr-2">Refresh</button>
                        <button id="closePortfolioModal2"
                            class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Close</button>
                    </div>
                </div>
            </div>
        </div>
        </div>

        <!-- Save Modal -->
        <div id="saveModal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center z-50">
            <div class="bg-white rounded-lg w-11/12 max-w-md p-6 shadow-lg">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold">Save Portfolio</h3>
                    <button id="closeSaveModal" class="text-gray-500 hover:text-gray-800">âœ•</button>
                </div>
                <div class="space-y-3">
                    <label class="block text-sm font-medium text-gray-700">Portfolio Name</label>
                    <input id="saveNameInput" type="text" class="w-full px-3 py-2 border rounded-lg"
                        placeholder="My Portfolio">

                    <label class="flex items-center space-x-2 mt-2">
                        <input id="saveFetchLive" type="checkbox" class="w-4 h-4" />
                        <span class="text-sm text-gray-600">Fetch live prices when loading</span>
                    </label>
                </div>
                <div class="mt-4 text-right">
                    <button id="confirmSaveBtn"
                        class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 mr-2">Save</button>
                    <button id="cancelSaveBtn"
                        class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancel</button>
                </div>
            </div>
        </div>

        <script>
            // Configuration -        <script>
            // ========== TOAST NOTIFICATION SYSTEM ==========
            const Toast = {
                show(message, type = 'info', title = '', duration = 3000) {
                    const container = document.getElementById('toastContainer');
                    const id = 'toast-' + Date.now();

                    const icons = {
                        success: 'fa-check-circle',
                        error: 'fa-exclamation-circle',
                        warning: 'fa-exclamation-triangle',
                        info: 'fa-info-circle'
                    };

                    const titles = {
                        success: title || 'Success',
                        error: title || 'Error',
                        warning: title || 'Warning',
                        info: title || 'Info'
                    };

                    const toastHTML = `
                        <div id="${id}" class="toast ${type}">
                            <div class="toast-icon">
                                <i class="fas ${icons[type]}"></i>
                            </div>
                            <div class="toast-content">
                                <div class="toast-title">${titles[type]}</div>
                                <div class="toast-message">${message}</div>
                            </div>
                            <div class="toast-close" onclick="Toast.remove('${id}')">
                                <i class="fas fa-times"></i>
                            </div>
                        </div>
                    `;

                    container.insertAdjacentHTML('beforeend', toastHTML);

                    if (duration > 0) {
                        setTimeout(() => this.remove(id), duration);
                    }

                    return id;
                },

                remove(id) {
                    const toast = document.getElementById(id);
                    if (toast) {
                        toast.style.animation = 'slideOutRight 0.3s ease-out';
                        setTimeout(() => toast.remove(), 300);
                    }
                },

                success(message, title) {
                    return this.show(message, 'success', title);
                },

                error(message, title) {
                    return this.show(message, 'error', title, 5000);
                },

                warning(message, title) {
                    return this.show(message, 'warning', title, 4000);
                },

                info(message, title) {
                    return this.show(message, 'info', title);
                }
            };

            // Make Toast available globally
            window.Toast = Toast;

            const API_URL = 'https://portfolio-analytics-dashboard-production-9940.up.railway.app';

            // Global variables
            let portfolioData = null;
            let currentPortfolioId = null;
            let charts = {};
            let currentFile = null;

            // DOM Elements
            const uploadSection = document.getElementById('uploadSection');
            const dashboardSection = document.getElementById('dashboardSection');
            const dropArea = document.getElementById('dropArea');
            const fileInput = document.getElementById('fileInput');
            const uploadStatus = document.getElementById('uploadStatus');
            const uploadError = document.getElementById('uploadError');
            const errorMessage = document.getElementById('errorMessage');
            const uploadNewBtn = document.getElementById('uploadNewBtn');
            const exportPdfBtn = document.getElementById('exportPdfBtn');
            const savePortfolioBtn = document.getElementById('savePortfolioBtn');
            const loadPortfolioBtn = document.getElementById('loadPortfolioBtn');
            const portfolioModal = document.getElementById('portfolioModal');
            const portfolioList = document.getElementById('portfolioList');
            const closePortfolioModal = document.getElementById('closePortfolioModal');
            const closePortfolioModal2 = document.getElementById('closePortfolioModal2');
            const refreshPortfolioList = document.getElementById('refreshPortfolioList');
            const searchInput = document.getElementById('searchInput');
            const exportBtn = document.getElementById('exportBtn');
            const refreshPricesBtn = document.getElementById('refreshPricesBtn');
            const autoRefreshToggle = document.getElementById('autoRefreshToggle');
            const lastRefreshed = document.getElementById('lastRefreshed');

            // Initialize
            document.addEventListener('DOMContentLoaded', () => {
                setupEventListeners();
            });

            function setupEventListeners() {
                // File upload
                dropArea.addEventListener('click', () => fileInput.click());
                fileInput.addEventListener('change', handleFileSelect);

                // Drag and drop
                dropArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropArea.classList.add('dragover');
                });

                dropArea.addEventListener('dragleave', () => {
                    dropArea.classList.remove('dragover');
                });

                dropArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropArea.classList.remove('dragover');
                    const file = e.dataTransfer.files[0];
                    if (file) {
                        uploadFile(file);
                    }
                });

                // Upload new file
                uploadNewBtn.addEventListener('click', () => {
                    dashboardSection.classList.add('hidden');
                    uploadSection.classList.remove('hidden');
                    uploadNewBtn.classList.add('hidden');
                    fileInput.value = '';
                });

                // Search
                searchInput.addEventListener('input', filterTable);

                // Export to PDF
                exportPdfBtn.addEventListener('click', exportToPDF);

                // Export
                exportBtn.addEventListener('click', exportToCSV);
                if (refreshPricesBtn) refreshPricesBtn.addEventListener('click', refreshLivePrices);
                if (autoRefreshToggle) autoRefreshToggle.addEventListener('change', (e) => {
                    if (e.target.checked) startAutoRefresh(); else stopAutoRefresh();
                });

                // Save / Load
                if (savePortfolioBtn) savePortfolioBtn.addEventListener('click', openSaveModal);
                if (loadPortfolioBtn) loadPortfolioBtn.addEventListener('click', openPortfolioModal);
                if (closePortfolioModal) closePortfolioModal.addEventListener('click', closePortfolioModalFn);
                if (closePortfolioModal2) closePortfolioModal2.addEventListener('click', closePortfolioModalFn);
                if (refreshPortfolioList) refreshPortfolioList.addEventListener('click', fetchAndRenderPortfolios);

                // Add Asset Modal
                document.getElementById('addAssetBtn').addEventListener('click', () => {
                    document.getElementById('addAssetModal').classList.remove('hidden');
                });
                document.getElementById('closeAddAssetModal').addEventListener('click', () => {
                    document.getElementById('addAssetModal').classList.add('hidden');
                });
                document.getElementById('addAssetForm').addEventListener('submit', handleAddAsset);

                // Initial load
                updateWealthMetrics();
                loadWatchlist();
                loadNews();
            }

            // News Logic
            async function loadNews() {
                const newsFeed = document.getElementById('newsFeed');
                if (!newsFeed) return;

                try {
                    // Get top holdings from portfolio if available
                    let tickers = '';
                    if (portfolioData && portfolioData.holdings) {
                        tickers = portfolioData.holdings
                            .sort((a, b) => (b.quantity * b.price) - (a.quantity * a.price))
                            .slice(0, 3)
                            .map(h => h.ticker)
                            .join(',');
                    }

                    const url = tickers ? `${API_URL}/api/v2/market/news?tickers=${tickers}` : `${API_URL}/api/v2/market/news`;
                    const res = await fetch(url);
                    if (res.ok) {
                        const data = await res.json();
                        renderNews(data.news);
                    }
                } catch (e) {
                    console.error("News fetch error", e);
                    newsFeed.innerHTML = '<div class="text-center text-red-400">Failed to load news</div>';
                }
            }

            function renderNews(items) {
                const newsFeed = document.getElementById('newsFeed');
                if (!newsFeed) return;

                if (!items || items.length === 0) {
                    newsFeed.innerHTML = '<div class="text-center text-gray-400">No news found</div>';
                    return;
                }

                newsFeed.innerHTML = items.map(item => `
                    <a href="${item.link}" target="_blank" class="block group">
                        <div class="flex space-x-3 p-2 hover:bg-gray-50 rounded-lg transition">
                            ${item.thumbnail ? `<img src="${item.thumbnail}" class="w-16 h-16 object-cover rounded-md flex-shrink-0">` : ''}
                            <div class="flex-1">
                                <h4 class="text-sm font-medium text-gray-900 group-hover:text-blue-600 line-clamp-2">${item.title}</h4>
                                <div class="flex justify-between items-center mt-1">
                                    <span class="text-xs text-gray-500">${item.publisher}</span>
                                    <span class="text-xs text-gray-400">${new Date(item.publishDate).toLocaleDateString()}</span>
                                </div>
                            </div>
                        </div>
                    </a>
                `).join('');
            }

            document.getElementById('refreshNewsBtn')?.addEventListener('click', loadNews);

            // Chat Widget Logic
            let isChatOpen = false;

            function toggleChat() {
                const win = document.getElementById('chatWindow');
                isChatOpen = !isChatOpen;
                if (isChatOpen) {
                    win.classList.add('open');
                    setTimeout(() => document.getElementById('chatInput').focus(), 300);
                } else {
                    win.classList.remove('open');
                }
            }

            function handleChatKey(e) {
                if (e.key === 'Enter') sendMessage();
            }

            async function sendMessage() {
                const input = document.getElementById('chatInput');
                const text = input.value.trim();
                if (!text) return;

                // Add User Message
                addMessage(text, 'user');
                input.value = '';

                // Show Typing...
                const typingId = addTypingIndicator();

                try {
                    // Prepare context
                    let context = {};
                    if (portfolioData) {
                        context = {
                            net_worth: calculateTotalWealth() || 0,
                            holdings: portfolioData.holdings || []
                        };
                    }

                    const res = await fetch(`${API_URL}/api/v2/ai/chat`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            message: text,
                            portfolio_context: context
                        })
                    });

                    removeMessage(typingId);

                    if (res.ok) {
                        const data = await res.json();
                        addMessage(data.response, 'bot');
                    } else {
                        addMessage("Sorry, I'm having trouble connecting to my brain right now.", 'bot');
                    }
                } catch (e) {
                    removeMessage(typingId);
                    addMessage("Network connection failed.", 'bot');
                    console.error(e);
                }
            }

            function addMessage(text, sender) {
                const div = document.createElement('div');
                div.className = sender === 'user' ? 'flex items-end justify-end space-x-2' : 'flex items-start space-x-2';

                const bubble = document.createElement('div');
                bubble.className = sender === 'user'
                    ? 'bg-blue-600 text-white p-3 rounded-2xl rounded-tr-none shadow-sm text-sm max-w-[80%]'
                    : 'bg-white text-gray-700 p-3 rounded-2xl rounded-tl-none shadow-sm text-sm border border-gray-100 max-w-[80%]';

                // Parse markdown-ish features for bot
                if (sender === 'bot') {
                    bubble.innerHTML = text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
                } else {
                    bubble.innerText = text;
                }

                if (sender === 'bot') {
                    const icon = document.createElement('div');
                    icon.className = 'w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0 text-blue-600';
                    icon.innerHTML = '<i class="fas fa-robot text-xs"></i>';
                    div.appendChild(icon);
                    div.appendChild(bubble);
                } else {
                    div.appendChild(bubble);
                }

                const container = document.getElementById('chatMessages');
                container.appendChild(div);
                container.scrollTop = container.scrollHeight;
                return div.id = 'msg-' + Date.now();
            }

            function addTypingIndicator() {
                const id = 'typing-' + Date.now();
                const div = document.createElement('div');
                div.id = id;
                div.className = 'flex items-start space-x-2';
                div.innerHTML = `
                    <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0 text-blue-600"><i class="fas fa-robot text-xs"></i></div>
                    <div class="bg-white p-4 rounded-2xl rounded-tl-none shadow-sm border border-gray-100">
                        <div class="flex space-x-1">
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
                        </div>
                    </div>
                 `;
                const container = document.getElementById('chatMessages');
                container.appendChild(div);
                container.scrollTop = container.scrollHeight;
                return id;
            }

            function removeMessage(id) {
                const el = document.getElementById(id);
                if (el) el.remove();
            }

            // Placeholder for calculateTotalWealth if not defined elsewhere
            function calculateTotalWealth() {
                if (!portfolioData || !portfolioData.holdings) return 0;
                return portfolioData.holdings.reduce((sum, h) => sum + (h.value || 0), 0);
            }

            async function loadWatchlist() {
                try {
                    const res = await fetch(`${API_URL}/api/v2/watchlist`);
                    if (res.ok) {
                        const data = await res.json();
                        renderWatchlist(data);
                    }
                } catch (e) { console.error("Watchlist load failed", e); }
            }

            async function addToWatchlist() {
                const ticker = document.getElementById('watchlistInput').value;
                if (!ticker) return;
                try {
                    const res = await fetch(`${API_URL}/api/v2/watchlist/items?ticker=${ticker}`, { method: 'POST' });
                    if (res.ok) {
                        const data = await res.json();
                        renderWatchlist(data);
                        document.getElementById('watchlistInput').value = '';
                    }
                } catch (e) { console.error("Add watchlist failed", e); }
            }

            async function removeFromWatchlist(ticker) {
                try {
                    const res = await fetch(`${API_URL}/api/v2/watchlist/items/${ticker}`, { method: 'DELETE' });
                    if (res.ok) {
                        const data = await res.json();
                        renderWatchlist(data);
                    }
                } catch (e) { console.error("Remove watchlist failed", e); }
            }

            function renderWatchlist(data) {
                const tbody = document.getElementById('watchlistBody');
                if (!tbody) return;

                tbody.innerHTML = data.items.map(item => `
                    <tr>
                        <td class="py-3 font-medium text-gray-900">${item.ticker}</td>
                        <td class="py-3 text-gray-600">$ -</td>
                        <td class="py-3 text-gray-600">-</td>
                        <td class="py-3 text-right">
                            <button onclick="removeFromWatchlist('${item.ticker}')" class="text-red-400 hover:text-red-600 text-xs">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');

                if (data.items.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="py-4 text-center text-gray-400">No items in watchlist</td></tr>';
                }
            }

            document.getElementById('addToWatchlistBtn')?.addEventListener('click', addToWatchlist);

            async function updateWealthMetrics() {
                try {
                    const res = await fetch(`${API_URL}/api/v2/wealth/net-worth`);
                    if (!res.ok) return;
                    const data = await res.json();

                    const nwEl = document.getElementById('netWorthValue');
                    if (nwEl) nwEl.textContent = formatCurrency(data.net_worth);

                    const assetsEl = document.getElementById('totalAssetsValue');
                    if (assetsEl) assetsEl.textContent = formatCurrency(data.total_assets);

                    const liabEl = document.getElementById('totalLiabilitiesValue');
                    if (liabEl) liabEl.textContent = formatCurrency(data.total_liabilities);

                } catch (e) {
                    console.error("Wealth fetch failed", e);
                }
            }

            function handleFileSelect(event) {
                const file = event.target.files[0];
                if (file) {
                    uploadFile(file);
                }
            }

            async function uploadFile(file) {
                // Store file reference
                currentFile = file;
                // Validate file type
                const validExtensions = ['.csv', '.xlsx', '.xls'];
                const fileExtension = file.name.substring(file.name.lastIndexOf('.')).toLowerCase();

                if (!validExtensions.includes(fileExtension)) {
                    showError('Invalid file type. Please upload a CSV or Excel file.');
                    return;
                }

                // Show loading
                uploadStatus.classList.remove('hidden');
                uploadError.classList.add('hidden');

                // Create form data
                const formData = new FormData();
                formData.append('file', file);


                try {
                    console.log('[DEBUG] Starting portfolio upload...');
                    const response = await fetch(`${API_URL}/api/v2/import/smart`, {
                        method: 'POST',
                        body: formData
                    });

                    console.log('[DEBUG] API Response status:', response.status);

                    if (!response.ok) {
                        const error = await response.json();
                        console.error('[DEBUG] API Error:', error);
                        throw new Error(error.detail || 'Upload failed');
                    }

                    const data = await response.json();
                    console.log('[DEBUG] API Response data:', data);
                    console.log('[DEBUG] Holdings count:', data.holdings?.length || 0);

                    // Transform API response to match expected format
                    portfolioData = transformImportResponse(data);
                    console.log('[DEBUG] Transformed portfolio data:', portfolioData);


                    // Hide upload, show dashboard
                    uploadStatus.classList.add('hidden');
                    uploadSection.classList.add('hidden');
                    dashboardSection.classList.remove('hidden');
                    uploadNewBtn.classList.remove('hidden');
                    exportPdfBtn.classList.remove('hidden');  // Show PDF export button

                    // Show success message
                    const holdingsCount = data.holdings?.length || portfolioData.holdings?.length || 0;
                    console.log(`[DEBUG] âœ“ Portfolio loaded successfully with ${holdingsCount} holdings`);

                    // Reveal client name input and prefill if available
                    try {
                        const clientInput = document.getElementById('clientNameInput');
                        if (clientInput) {
                            clientInput.classList.remove('hidden');
                            clientInput.value = (data && data.metadata && (data.metadata.saved_name || data.metadata.filename)) || '';
                        }
                    } catch (e) { console.warn('[DEBUG] Client input error:', e); }

                    // Render dashboard
                    console.log('[DEBUG] Calling renderDashboard...');
                    renderDashboard(data);
                    console.log('[DEBUG] Dashboard render complete');

                } catch (error) {
                    console.error('[DEBUG] Upload error:', error);
                    uploadStatus.classList.add('hidden');
                    showError(error.message);
                }
            }

            function showError(message) {
                errorMessage.textContent = message;
                uploadError.classList.remove('hidden');
            }

            function transformImportResponse(apiResponse) {
                /**
                 * Transform API response to match dashboard expected format
                 */
                const holdings = apiResponse.holdings || [];

                // Build summary from holdings
                const summary = {
                    total_value: holdings.reduce((sum, h) => sum + (h.value || 0), 0),
                    total_principal: holdings.reduce((sum, h) => sum + (h['Principal ($)'] || 0), 0),
                    total_gain_loss: 0,
                    total_daily_change: 0,
                    overall_return_pct: 0,
                    daily_return_pct: 0,
                    total_annual_income: 0,
                    avg_yield: 0,
                    num_holdings: holdings.length
                };

                // Calculate metrics
                if (holdings.length > 0) {
                    summary.total_gain_loss = holdings.reduce((sum, h) => sum + (h['NFS G/L ($)'] || 0), 0);
                    summary.overall_return_pct = (summary.total_gain_loss / summary.total_principal) * 100 || 0;
                    summary.total_daily_change = holdings.reduce((sum, h) => sum + (h['1-Day Value Change ($)'] || 0), 0);
                    summary.daily_return_pct = summary.total_value > 0 ? (summary.total_daily_change / summary.total_value) * 100 : 0;
                    summary.total_annual_income = holdings.reduce((sum, h) => sum + (h['Est Annual Income ($)'] || 0), 0);
                    summary.avg_yield = holdings.reduce((sum, h) => sum + (h['Current Yld/Dist Rate (%)'] || 0), 0) / holdings.length;
                }

                // Build charts data
                const charts = {
                    allocation_by_symbol: holdings.map(h => ({
                        Symbol: h.Symbol || h.ticker || '',
                        'Value ($)': h.value || 0,
                        'Assets (%)': (h.allocation_pct || 0)
                    })),
                    allocation_by_type: buildAllocationByType(holdings),
                    gain_loss_by_symbol: holdings.map(h => ({
                        Symbol: h.Symbol || h.ticker || '',
                        'NFS G/L ($)': h['NFS G/L ($)'] || 0
                    })),
                    daily_movement: holdings.map(h => ({
                        Symbol: h.Symbol || h.ticker || '',
                        '1-Day Value Change ($)': h['1-Day Value Change ($)'] || 0
                    }))
                };

                return {
                    success: true,
                    summary: summary,
                    charts: charts,
                    holdings: holdings
                };
            }

            function buildAllocationByType(holdings) {
                /**
                 * Group holdings by asset type
                 */
                const grouped = {};

                holdings.forEach(h => {
                    const type = h['Asset Type'] || 'Stock';
                    if (!grouped[type]) {
                        grouped[type] = {
                            'Asset Type': type,
                            'Value ($)': 0
                        };
                    }
                    grouped[type]['Value ($)'] += h.value || 0;
                });

                return Object.values(grouped);
            }

            function renderDashboard(data) {
                console.log('[DEBUG] renderDashboard called with:', data);

                try {
                    // Update summary cards
                    console.log('[DEBUG] Updating summary cards...');
                    updateSummaryCards(data.summary);

                    // Generate and display portfolio analysis text
                    console.log('[DEBUG] Generating portfolio analysis...');
                    displayPortfolioAnalysis(data);

                    // Render charts
                    console.log('[DEBUG] Rendering charts...');
                    renderCharts(data.charts);

                    // Render table
                    console.log('[DEBUG] Rendering holdings table...');
                    renderHoldingsTable(data.holdings);

                    // Setup analytics tabs
                    console.log('[DEBUG] Setting up analytics tabs...');
                    setupAnalyticsTabs();

                    // Fetch and render advanced analytics
                    if (currentFile) {
                        console.log('[DEBUG] Fetching advanced analytics for file...');
                        fetchAdvancedAnalytics(currentFile).then(analytics => {
                            if (analytics) {
                                renderAdvancedAnalytics(analytics); // Existing tab population
                                renderDeepAnalytics(analytics);     // New dashboard widgets
                            }
                        });
                    } else if (currentPortfolioId) {
                        console.log('[DEBUG] Fetching analytics for saved portfolio...');
                        // Fetch analytics for saved portfolio
                        fetchSavedPortfolioAnalytics(currentPortfolioId);
                    }

                    console.log('[DEBUG] âœ“ All dashboard sections rendered successfully');
                } catch (error) {
                    console.error('[DEBUG] Error in renderDashboard:', error);
                    showError(`Failed to render dashboard: ${error.message}`);
                }
            }

            function displayPortfolioAnalysis(data) {
                /**
                 * Generate and display narrative portfolio analysis
                 */
                const container = document.getElementById('portfolioAnalysisText');
                if (!container) {
                    console.warn('[DEBUG] portfolioAnalysisText container not found');
                    return;
                }

                const summary = data.summary || {};
                const holdings = data.holdings || [];

                const totalValue = formatCurrency(summary.total_value || 0);
                const returnPct = (summary.overall_return_pct || 0).toFixed(2);
                const gainLoss = formatCurrency(summary.total_gain_loss || 0);
                const annualIncome = formatCurrency(summary.total_annual_income || 0);
                const avgYield = (summary.avg_yield || 0).toFixed(2);
                const numHoldings = summary.num_holdings || holdings.length || 0;

                const isPositive = (summary.total_gain_loss || 0) >= 0;
                const performanceClass = isPositive ? 'text-green-600' : 'text-red-600';
                const performanceIcon = isPositive ? 'fa-arrow-up' : 'fa-arrow-down';

                // Calculate diversification insight
                let diversificationText = '';
                if (numHoldings < 5) {
                    diversificationText = '<p class="text-yellow-700 bg-yellow-50 p-3 rounded-lg"><i class="fas fa-exclamation-triangle mr-2"></i><strong>Low Diversification:</strong> Consider adding more holdings to reduce concentration risk.</p>';
                } else if (numHoldings >= 5 && numHoldings <= 20) {
                    diversificationText = '<p class="text-blue-700 bg-blue-50 p-3 rounded-lg"><i class="fas fa-info-circle mr-2"></i><strong>Moderate Diversification:</strong> Your portfolio has a reasonable spread across ' + numHoldings + ' positions.</p>';
                } else {
                    diversificationText = '<p class="text-green-700 bg-green-50 p-3 rounded-lg"><i class="fas fa-check-circle mr-2"></i><strong>Well Diversified:</strong> Excellent diversification with ' + numHoldings + ' different holdings.</p>';
                }

                const analysisHTML = `
                    <div class="space-y-4">
                        <p class="text-base">
                            <i class="fas fa-briefcase text-blue-600 mr-2"></i>
                            <strong>Portfolio Overview:</strong> Your portfolio consists of <span class="font-semibold text-blue-600">${numHoldings} holdings</span> with a total value of <span class="font-semibold">${totalValue}</span>.
                        </p>
                        
                        <p class="text-base">
                            <i class="fas ${performanceIcon} ${performanceClass} mr-2"></i>
                            <strong>Performance:</strong> Your portfolio has ${isPositive ? 'gained' : 'lost'} <span class="font-semibold ${performanceClass}">${gainLoss}</span> (<span class="${performanceClass}">${returnPct}%</span>) since inception.
                        </p>
                        
                        <p class="text-base">
                            <i class="fas fa-dollar-sign text-green-600 mr-2"></i>
                            <strong>Income Generation:</strong> Your holdings are projected to generate <span class="font-semibold text-green-600">${annualIncome}</span> in annual dividend income, yielding an average of <span class="font-semibold">${avgYield}%</span> across all positions.
                        </p>
                        
                        ${diversificationText}
                       
                        <div class="bg-gray-50 p-4 rounded-lg border-l-4 border-blue-500">
                            <p class="text-sm text-gray-700">
                                <i class="fas fa-lightbulb text-yellow-500 mr-2"></i>
                                <strong>Quick Insight:</strong> ${getQuickInsight(summary, numHoldings)}
                            </p>
                        </div>
                    </div>
                `;

                container.innerHTML = analysisHTML;
                console.log('[DEBUG] Portfolio analysis displayed');
            }

            function getQuickInsight(summary, numHoldings) {
                /**
                 * Generate a quick insight based on portfolio metrics
                 */
                const returnPct = summary.overall_return_pct || 0;
                const avgYield = summary.avg_yield || 0;

                if (returnPct > 20) {
                    return 'Your portfolio is showing strong performance! Consider reviewing to ensure risk levels remain comfortable.';
                } else if (returnPct > 10) {
                    return 'Solid performance. Your portfolio is on a good trajectory.';
                } else if (returnPct > 0) {
                    return 'Positive returns! Consider exploring opportunities to enhance growth.';
                } else if (returnPct > -10) {
                    return 'Minor losses are normal. Review underperformers and consider rebalancing.';
                } else {
                    return 'Significant decline detected. Consider reviewing your asset allocation and risk tolerance.';
                }
            }

            function renderDeepAnalytics(analytics) {
                // 1. Sector Allocation (Dashboard Widget)
                if (analytics.sector_allocation && analytics.sector_allocation.sectors) {
                    const ctx = document.getElementById('sectorAllocationChart').getContext('2d');
                    if (charts.sectorDashboard) charts.sectorDashboard.destroy();

                    const sectors = analytics.sector_allocation.sectors;
                    charts.sectorDashboard = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: sectors.map(s => s.sector),
                            datasets: [{
                                data: sectors.map(s => s.value),
                                backgroundColor: ['#6366F1', '#EC4899', '#8B5CF6', '#14B8A6', '#F97316', '#F43F5E', '#10B981', '#3B82F6'],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { position: 'right', labels: { boxWidth: 10 } },
                                tooltip: {
                                    callbacks: {
                                        label: (ctx) => ` ${ctx.label}: ${formatCurrency(ctx.raw)} (${sectors[ctx.dataIndex].percent}%)`
                                    }
                                }
                            },
                            cutout: '70%'
                        }
                    });

                    // Populate Sector Table (Dashboard)
                    const tbody = document.getElementById('sectorTable');
                    if (tbody) {
                        tbody.innerHTML = sectors.slice(0, 5).map(s => `
                            <tr class="border-b border-gray-50 last:border-0">
                                <td class="px-4 py-2 font-medium text-gray-800">${s.sector}</td>
                                <td class="px-4 py-2 text-gray-600">${formatCurrency(s.value)}</td>
                                <td class="px-4 py-2 text-gray-600">${s.percent}%</td>
                            </tr>
                        `).join('');
                    }
                }

                // 2. Risk Metrics (Dashboard Card)
                if (analytics.advanced_risk && analytics.advanced_risk.metrics) {
                    const m = analytics.advanced_risk.metrics;
                    const setTxt = (id, txt) => { const el = document.getElementById(id); if (el) el.innerText = txt; };

                    setTxt('metricBeta', m.beta);
                    setTxt('metricSharpe', m.sharpe);
                    setTxt('metricVol', m.volatility + '%');

                    const bar = document.getElementById('barBeta');
                    if (bar) {
                        const pct = Math.min((m.beta / 2) * 100, 100);
                        bar.style.width = pct + '%';
                        bar.className = `h-1.5 rounded-full ${m.beta > 1.2 ? 'bg-red-500' : (m.beta < 0.8 ? 'bg-green-500' : 'bg-yellow-500')}`;
                    }
                }
            }

            async function fetchSavedPortfolioAnalytics(id) {
                try {
                    const res = await fetch(`${API_URL}/api/v2/portfolio/${id}/analytics`);
                    if (!res.ok) return;
                    const data = await res.json();

                    if (data.analytics) {
                        renderAdvancedAnalytics(data.analytics);
                        if (data.analytics.benchmark_comparison) {
                            renderBenchmarkChart(data.analytics.benchmark_comparison);
                        }
                        if (data.analytics.dividend_calendar) {
                            renderDividendCalendar(data.analytics.dividend_calendar);
                        }
                    }
                } catch (e) {
                    console.error("Analytics fetch error", e);
                }
            }

            function renderDividendCalendar(data) {
                // Update Total
                document.getElementById('totalProjectedIncome').innerText = formatCurrency(data.total_projected_12m);

                // Render List
                const listParams = data.upcoming_dividends || [];
                const tbody = document.getElementById('dividendList');
                tbody.innerHTML = listParams.map(d => `
                    <tr>
                        <td class="py-2">${d.date}</td>
                        <td class="py-2"><span class="font-bold text-white">${d.symbol}</span></td>
                        <td class="py-2 text-right text-green-400">+${formatCurrency(d.amount)}</td>
                    </tr>
                 `).join('');

                if (listParams.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" class="py-4 text-center text-gray-500">No upcoming dividends projected</td></tr>';
                }

                // Render Chart
                const ctx = document.getElementById('dividendChart').getContext('2d');
                if (charts.dividend) charts.dividend.destroy();

                const monthly = data.monthly_totals || [];
                const labels = monthly.map(m => m.month);
                const values = monthly.map(m => m.amount);

                charts.dividend = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Projected Income',
                            data: values,
                            backgroundColor: '#10b981', // Emerald
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                ticks: { callback: (val) => '$' + val }
                            },
                            x: {
                                grid: { display: false }
                            }
                        },
                        plugins: {
                            legend: { display: false }
                        }
                    }
                });
            }

            function renderBenchmarkChart(data) {
                const ctx = document.getElementById('benchmarkChart').getContext('2d');
                if (charts.benchmark) charts.benchmark.destroy();

                const dates = data.dates;
                const portVals = data.portfolio;
                const benchVals = data.benchmark;

                charts.benchmark = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: dates,
                        datasets: [
                            {
                                label: 'My Portfolio',
                                data: portVals,
                                borderColor: '#8b5cf6', // Purple
                                backgroundColor: 'rgba(139, 92, 246, 0.1)',
                                borderWidth: 2,
                                fill: true,
                                tension: 0.1
                            },
                            {
                                label: 'S&P 500 (Benchmark)',
                                data: benchVals,
                                borderColor: '#6b7280', // Gray
                                borderWidth: 2,
                                borderDash: [5, 5],
                                fill: false,
                                tension: 0.1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        scales: {
                            y: {
                                title: { display: true, text: 'Growth of $100' }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        return context.dataset.label + ': $' + context.parsed.y.toFixed(2);
                                    }
                                }
                            }
                        }
                    }
                });

                // Render metrics
                const metrics = data.metrics || {};
                const mEl = document.getElementById('benchmarkMetrics');
                if (mEl) {
                    const alphaClass = metrics.alpha >= 0 ? 'text-green-400' : 'text-red-400';
                    mEl.innerHTML = `
                        <div class="bg-gray-800 rounded p-2">
                            <div class="text-xs text-gray-400">Portfolio Return</div>
                            <div class="font-bold text-lg text-white">${metrics.portfolio_return}%</div>
                        </div>
                        <div class="bg-gray-800 rounded p-2">
                            <div class="text-xs text-gray-400">S&P 500 Return</div>
                            <div class="font-bold text-lg text-gray-300">${metrics.benchmark_return}%</div>
                        </div>
                        <div class="bg-gray-800 rounded p-2">
                            <div class="text-xs text-gray-400">Alpha</div>
                            <div class="font-bold text-lg ${alphaClass}">${metrics.alpha > 0 ? '+' : ''}${metrics.alpha}%</div>
                        </div>
                    `;
                }
            }

            function updateSummaryCards(summary) {
                // Total Value
                document.getElementById('totalValue').textContent = formatCurrency(summary.total_value);

                const dailyChangeEl = document.getElementById('dailyChange');
                const changeClass = summary.total_daily_change >= 0 ? 'positive' : 'negative';
                const changeIcon = summary.total_daily_change >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';
                dailyChangeEl.innerHTML = `
                <span class="text-gray-600 mr-2">Today:</span>
                <span class="${changeClass} font-semibold">
                    ${formatCurrency(summary.total_daily_change)}
                    (${summary.daily_return_pct.toFixed(2)}%)
                </span>
                <i class="fas ${changeIcon} ${changeClass} ml-1"></i>
            `;

                // Gain/Loss
                const glEl = document.getElementById('totalGainLoss');
                const glClass = summary.total_gain_loss >= 0 ? 'positive' : 'negative';
                glEl.textContent = formatCurrency(summary.total_gain_loss);
                glEl.className = `text-3xl font-bold ${glClass}`;

                const returnEl = document.getElementById('returnPct');
                returnEl.innerHTML = `
                <span class="text-gray-600 mr-2">Return:</span>
                <span class="${glClass} font-semibold">${summary.overall_return_pct.toFixed(2)}%</span>
            `;

                // Annual Income
                document.getElementById('annualIncome').textContent = formatCurrency(summary.total_annual_income);
                document.getElementById('avgYield').innerHTML = `
                <span class="text-gray-600 mr-2">Avg Yield:</span>
                <span class="font-semibold">${summary.avg_yield.toFixed(2)}%</span>
            `;

                // Holdings
                document.getElementById('holdingsCount').textContent = summary.num_holdings;
                document.getElementById('principalAmount').textContent = `Principal: ${formatCurrency(summary.total_principal)}`;
            }

            function renderCharts(chartData) {
                // Destroy existing charts
                Object.values(charts).forEach(chart => chart.destroy());
                charts = {};

                // 1. Portfolio Allocation Pie Chart
                const allocCtx = document.getElementById('allocationChart').getContext('2d');
                charts.allocation = new Chart(allocCtx, {
                    type: 'pie',
                    data: {
                        labels: chartData.allocation_by_symbol.map(d => d.Symbol),
                        datasets: [{
                            data: chartData.allocation_by_symbol.map(d => d['Value ($)']),
                            backgroundColor: generateColors(chartData.allocation_by_symbol.length)
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'right' },
                            tooltip: {
                                callbacks: {
                                    label: (context) => {
                                        const label = context.label || '';
                                        const value = formatCurrency(context.parsed);
                                        const pct = chartData.allocation_by_symbol[context.dataIndex]['Assets (%)'].toFixed(2);
                                        return `${label}: ${value} (${pct}%)`;
                                    }
                                }
                            }
                        }
                    }
                });

                // 2. Asset Type Distribution
                const typeCtx = document.getElementById('assetTypeChart').getContext('2d');
                charts.assetType = new Chart(typeCtx, {
                    type: 'doughnut',
                    data: {
                        labels: chartData.allocation_by_type.map(d => d['Asset Type']),
                        datasets: [{
                            data: chartData.allocation_by_type.map(d => d['Value ($)']),
                            backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'right' }
                        }
                    }
                });

                // 3. Gain/Loss Bar Chart
                const glCtx = document.getElementById('gainLossChart').getContext('2d');
                const glData = chartData.gain_loss_by_symbol;
                charts.gainLoss = new Chart(glCtx, {
                    type: 'bar',
                    data: {
                        labels: glData.map(d => d.Symbol),
                        datasets: [{
                            label: 'Gain/Loss ($)',
                            data: glData.map(d => d['NFS G/L ($)']),
                            backgroundColor: glData.map(d => d['NFS G/L ($)'] >= 0 ? '#10b981' : '#ef4444')
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            x: {
                                ticks: {
                                    callback: (value) => formatCurrency(value)
                                }
                            }
                        }
                    }
                });

                // 4. Daily Movement Bar Chart
                const dmCtx = document.getElementById('dailyMovementChart').getContext('2d');
                const dmData = chartData.daily_movement;
                charts.dailyMovement = new Chart(dmCtx, {
                    type: 'bar',
                    data: {
                        labels: dmData.map(d => d.Symbol),
                        datasets: [{
                            label: 'Daily Change ($)',
                            data: dmData.map(d => d['1-Day Value Change ($)']),
                            backgroundColor: dmData.map(d => d['1-Day Value Change ($)'] >= 0 ? '#10b981' : '#ef4444')
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            x: {
                                ticks: {
                                    callback: (value) => formatCurrency(value)
                                }
                            }
                        }
                    }
                });
            }

            function renderHoldingsTable(holdings) {
                const tbody = document.getElementById('holdingsTableBody');
                tbody.innerHTML = '';

                holdings.forEach(holding => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';

                    // Handle both old and new column names
                    const symbol = holding.Symbol || holding.ticker || '';
                    const description = holding.Description || holding.description || '';
                    const quantity = holding.Quantity || holding.quantity || 0;
                    const price = holding['Price ($)'] || holding.price || 0;
                    const value = holding['Value ($)'] || holding.value || 0;
                    const gainLoss = holding['NFS G/L ($)'] || 0;
                    const gainLossPct = holding['NFS G/L (%)'] || 0;
                    const yieldPct = holding['Current Yld/Dist Rate (%)'] || 0;

                    const glClass = gainLoss >= 0 ? 'positive' : 'negative';

                    row.innerHTML = `
                    <td class="px-4 py-3 font-semibold text-gray-900">${symbol}</td>
                    <td class="px-4 py-3 text-gray-700">${description}</td>
                    <td class="px-4 py-3 text-right text-gray-700">${quantity.toFixed(2)}</td>
                    <td class="px-4 py-3 text-right text-gray-700">${formatCurrency(price)}</td>
                    <td class="px-4 py-3 text-right font-semibold text-gray-900">${formatCurrency(value)}</td>
                    <td class="px-4 py-3 text-right font-semibold ${glClass}">${formatCurrency(gainLoss)}</td>
                    <td class="px-4 py-3 text-right ${glClass}">${gainLossPct.toFixed(2)}%</td>
                    <td class="px-4 py-3 text-right text-gray-700">${yieldPct.toFixed(2)}%</td>
                `;

                    tbody.appendChild(row);
                });
            }

            function filterTable() {
                const searchTerm = searchInput.value.toLowerCase();
                const rows = document.querySelectorAll('#holdingsTableBody tr');

                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(searchTerm) ? '' : 'none';
                });
            }

            /* ------------------ Portfolio Save / Load ------------------ */
            function buildSavePayload(name = 'My Portfolio') {
                // If an imported portfolio exists, use its normalized holdings
                if (portfolioData && Array.isArray(portfolioData.holdings) && portfolioData.holdings.length > 0) {
                    const holdings = portfolioData.holdings.map(h => {
                        return {
                            ticker: (h.Symbol || h.ticker || '').toString().toUpperCase(),
                            quantity: Number(h.Quantity || h.quantity || 0),
                            price: Number(h['Price ($)'] || h.price || 0),
                            cost_basis: Number(h['Principal ($)*'] || h.cost_basis || 0),
                            metadata: { description: h.Description || h.description || '' }
                        };
                    });
                    return { name, holdings };
                }

                // If no imported portfolio, but user built one in the Builder, convert weights -> quantities
                if (typeof builderHoldings !== 'undefined' && builderHoldings.length > 0) {
                    // Ask user for total portfolio value to convert weights into quantities
                    const totalStr = prompt('Enter total portfolio value to allocate (USD):', '100000');
                    const totalValue = Number(totalStr) || 0;
                    if (totalValue <= 0) {
                        alert('Invalid total value. Save cancelled.');
                        return null;
                    }

                    const holdings = builderHoldings.map(h => {
                        const weightPct = Number(h.weight) || 0;
                        const allocationValue = (weightPct / 100) * totalValue;
                        const price = Number(h.price) || 0.0;
                        const quantity = price > 0 ? Math.floor(allocationValue / price) : 0;
                        return {
                            ticker: (h.symbol || '').toString().toUpperCase(),
                            quantity: Number(quantity),
                            price: Number(price),
                            cost_basis: Number(price * quantity),
                            metadata: { description: '' }
                        };
                    });

                    return { name, holdings };
                }

                return null;
            }

            async function savePortfolio() {
                if (!portfolioData) {
                    alert('No portfolio loaded to save. Upload or build a portfolio first.');
                    return;
                }

                const name = prompt('Enter a name for this portfolio:', 'My Portfolio');
                if (!name) return;

                const payload = buildSavePayload(name);

                try {
                    const res = await fetch(`${API_URL}/api/v2/portfolio`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const data = await res.json();
                    if (res.ok) {
                        alert('Portfolio saved successfully');
                        // Set client name input to saved portfolio name for easier exports
                        try {
                            const clientInput = document.getElementById('clientNameInput');
                            if (clientInput) clientInput.value = data.name || name || '';
                            const idEl = document.getElementById('savedPortfolioId');
                            if (idEl) { idEl.style.display = ''; idEl.textContent = 'Saved ID: ' + (data.id || 'â€”'); }
                        } catch (e) { }
                    } else {
                        alert('Failed to save portfolio: ' + (data.detail || JSON.stringify(data)));
                    }
                } catch (err) {
                    alert('Error saving portfolio: ' + err.message);
                }
            }

            function openPortfolioModal() {
                document.getElementById('portfolioModal').classList.remove('hidden');
                fetchAndRenderPortfolios();
            }

            function closePortfolioModalFn() {
                document.getElementById('portfolioModal').classList.add('hidden');
                document.getElementById('portfolioList').innerHTML = '';
            }

            async function fetchAndRenderPortfolios() {
                const listEl = document.getElementById('portfolioList');
                listEl.innerHTML = '<p class="text-gray-500">Loading...</p>';
                try {
                    const res = await fetch(`${API_URL}/api/v2/portfolio`);
                    const data = await res.json();
                    if (!res.ok) throw new Error(data.detail || 'Failed to fetch portfolios');

                    if (!Array.isArray(data) || data.length === 0) {
                        listEl.innerHTML = '<p class="text-gray-500">No saved portfolios</p>';
                        return;
                    }

                    listEl.innerHTML = '';
                    data.forEach(p => {
                        const item = document.createElement('div');
                        item.className = 'flex items-center justify-between p-2 border rounded';
                        item.innerHTML = `
                            <div>
                                <div class="font-medium">${p.name}</div>
                                <div class="text-xs text-gray-500">${new Date(p.created_at).toLocaleDateString()}</div>
                            </div>
                            <div class="space-x-2">
                                <button class="px-3 py-1 bg-blue-600 text-white rounded load-portfolio" data-id="${p.id}">Load</button>
                                <button class="px-3 py-1 bg-red-500 text-white rounded delete-portfolio" data-id="${p.id}">Delete</button>
                            </div>
                        `;
                        listEl.appendChild(item);
                    });

                    // Attach event handlers
                    listEl.querySelectorAll('.load-portfolio').forEach(btn => {
                        btn.addEventListener('click', async (e) => {
                            const id = e.currentTarget.getAttribute('data-id');
                            const fetchLive = document.getElementById('loadFetchLive') ? document.getElementById('loadFetchLive').checked : true;
                            await loadPortfolio(id, fetchLive);
                            closePortfolioModalFn();
                        });
                    });

                    listEl.querySelectorAll('.delete-portfolio').forEach(btn => {
                        btn.addEventListener('click', async (e) => {
                            const id = e.currentTarget.getAttribute('data-id');
                            if (!confirm('Delete portfolio?')) return;
                            await deletePortfolio(id);
                            fetchAndRenderPortfolios();
                        });
                    });

                } catch (err) {
                    listEl.innerHTML = `<p class="text-red-500">${escapeHtml(err.message)}</p>`;
                }
            }

            async function loadPortfolio(id, fetchLive = true) {
                try {
                    const res = await fetch(`${API_URL}/api/v2/portfolio/${id}`);
                    if (!res.ok) throw new Error('Failed to load portfolio');
                    const data = await res.json();

                    // Set current ID
                    currentPortfolioId = data.id;
                    // Show add asset button
                    document.getElementById('addAssetBtn').classList.remove('hidden');

                    // Map holdings
                    const holdings = data.holdings.map(h => ({
                        ticker: h.ticker,
                        Symbol: h.ticker,
                        quantity: Number(h.quantity || 0),
                        Quantity: Number(h.quantity || 0),
                        price: Number(h.price || 0),
                        'Price ($)': Number(h.price || 0),
                        cost_basis: Number(h.cost_basis || 0) || 0,
                        'Principal ($)*': Number(h.cost_basis || 0) || 0,
                        value: (Number(h.price || 0) * Number(h.quantity || 0)) || 0,
                        allocation_pct: 0,
                        daily_change: 0,
                        yield_pct: h.metadata?.yield_pct || 0,
                        annual_income: h.metadata?.annual_income || 0
                    }));

                    // Optionally fetch live prices for these tickers
                    if (fetchLive) {
                        const tickers = holdings.map(h => h.ticker).filter(Boolean);
                        const quotes = await fetchLivePrices(tickers);

                        // Apply live prices if available
                        holdings.forEach(h => {
                            const q = quotes[h.ticker] || quotes[h.ticker.toUpperCase()];
                            if (q && typeof q.price !== 'undefined') {
                                const livePrice = Number(q.price || q.last || q.current || 0);
                                const changePct = Number(q.change_pct || q.changePercent || 0);
                                h.price = livePrice;
                                h['Price ($)'] = livePrice;
                                h.value = livePrice * (h.quantity || 0);
                                h.daily_change = (q.change_amt || 0);
                                h.change_pct = changePct;
                            }
                        });
                    }

                    // Recompute allocation and summary
                    const totalValue = holdings.reduce((s, it) => s + (it.value || 0), 0) || 0;
                    holdings.forEach(h => {
                        h.allocation_pct = totalValue ? ((h.value || 0) / totalValue) * 100 : 0;
                    });

                    const summary = computeSummaryFromHoldings(holdings);
                    const charts = computeChartsFromHoldings(holdings);

                    const mapped = { summary, charts, holdings };

                    portfolioData = mapped;
                    renderDashboard(mapped);
                    // switch to dashboard tab
                    document.querySelector('[data-tab="dashboard"]').click();
                    // If the loaded portfolio has a name or id, set header client input and saved id
                    try {
                        const clientInput = document.getElementById('clientNameInput');
                        if (clientInput) clientInput.value = data.name || (portfolioData.metadata && portfolioData.metadata.saved_name) || '';
                        const idEl = document.getElementById('savedPortfolioId');
                        if (idEl && data && data.id) { idEl.style.display = ''; idEl.textContent = 'Saved ID: ' + data.id; }
                    } catch (e) { }
                } catch (err) {
                    alert('Error loading portfolio: ' + err.message);
                }
            }

            async function deletePortfolio(id) {
                try {
                    const res = await fetch(`${API_URL}/api/v2/portfolio/${id}`, { method: 'DELETE' });
                    if (!res.ok) throw new Error('Delete failed');
                    alert('Deleted');
                } catch (err) {
                    alert('Error deleting portfolio: ' + err.message);
                }
            }

            /* ------------------ Save Modal & Live Price Helpers ------------------ */
            function openSaveModal() {
                // Pre-fill with a decent default name
                const nameInput = document.getElementById('saveNameInput');
                nameInput.value = portfolioData && portfolioData.summary && portfolioData.summary.num_holdings ? `Portfolio (${portfolioData.summary.num_holdings} holdings)` : 'My Portfolio';
                document.getElementById('saveModal').classList.remove('hidden');

                // Attach handlers
                document.getElementById('confirmSaveBtn').onclick = handleSaveConfirm;
                document.getElementById('cancelSaveBtn').onclick = closeSaveModal;
                document.getElementById('closeSaveModal').onclick = closeSaveModal;
            }

            function closeSaveModal() {
                document.getElementById('saveModal').classList.add('hidden');
            }

            async function handleSaveConfirm() {
                const name = document.getElementById('saveNameInput').value.trim();
                if (!name) {
                    alert('Please provide a name');
                    return;
                }

                const payload = buildSavePayload(name);
                if (!payload) {
                    alert('No portfolio data to save');
                    return;
                }

                try {
                    const res = await fetch(`${API_URL}/api/v2/portfolio`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const data = await res.json();
                    if (res.ok) {
                        // Store returned portfolio id & metadata so export can reference it
                        if (!portfolioData) portfolioData = {};
                        portfolioData.id = data.id;
                        portfolioData.metadata = portfolioData.metadata || {};
                        portfolioData.metadata.saved_name = data.name || payload.name;
                        // Update visible client input and header saved id
                        try {
                            document.getElementById('clientNameInput').value = data.name || payload.name || '';
                            const idEl = document.getElementById('savedPortfolioId');
                            if (idEl) { idEl.style.display = ''; idEl.textContent = 'Saved ID: ' + (data.id || 'â€”'); }
                        } catch (e) { }
                        alert('Portfolio saved successfully (ID: ' + data.id + ')');
                        closeSaveModal();
                    } else {
                        alert('Failed to save portfolio: ' + (data.detail || JSON.stringify(data)));
                    }
                } catch (err) {
                    alert('Error saving portfolio: ' + err.message);
                }
            }

            async function fetchLivePrices(tickers) {
                if (!tickers || tickers.length === 0) return {};
                try {
                    const res = await fetch(`${API_URL}/api/v2/market/quotes/batch`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ tickers })
                    });
                    if (!res.ok) return {};
                    const data = await res.json();
                    // Expected shape: { success: true, quotes: { TICKER: { price, change_pct, ... } }, count }
                    return data.quotes || {};
                } catch (err) {
                    console.error('fetchLivePrices error', err);
                    return {};
                }
            }

            // Auto-refresh state
            let _autoRefreshTimer = null;

            function startAutoRefresh() {
                // Avoid multiple timers
                if (_autoRefreshTimer) return;
                // Trigger an immediate refresh, then every 10s
                refreshLivePrices();
                _autoRefreshTimer = setInterval(() => refreshLivePrices(), 10000);
            }

            function stopAutoRefresh() {
                if (!_autoRefreshTimer) return;
                clearInterval(_autoRefreshTimer);
                _autoRefreshTimer = null;
            }

            async function exportToPDF() {
                // Prefer client name from the input field, otherwise prompt
                const clientInput = document.getElementById('clientNameInput');
                let clientName = clientInput ? (clientInput.value || '').trim() : '';
                if (!clientName) {
                    clientName = prompt('Enter client name for the report:', (portfolioData && portfolioData.metadata && (portfolioData.metadata.saved_name || portfolioData.metadata.filename)) || 'Valued Client');
                }

                // If user cancels prompt, do nothing
                if (clientName === null) return;

                try {
                    // Show loading state
                    exportPdfBtn.disabled = true;
                    exportPdfBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Generating PDF...';

                    const formData = new FormData();

                    // If there's a loaded file, send it
                    if (currentFile) {
                        formData.append('file', currentFile);
                    }

                    // If the portfolio was saved and we have an id, send portfolio_id instead
                    if (portfolioData && portfolioData.id) {
                        formData.append('portfolio_id', portfolioData.id);
                    }

                    formData.append('client_name', clientName);

                    const response = await fetch(`${API_URL}/api/portfolio/export-pdf`, {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        const err = await response.json().catch(() => ({ error: 'Unknown error' }));
                        throw new Error(err.detail || err.error || 'PDF generation failed');
                    }

                    // Get PDF blob
                    const blob = await response.blob();

                    // Create download link
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `Portfolio_Report_${new Date().toISOString().split('T')[0]}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);

                    // Show success message
                    alert('PDF report generated successfully!');

                } catch (error) {
                    console.error('PDF export failed:', error);
                    showError('Failed to generate PDF report: ' + (error.message || error));
                } finally {
                    // Reset button
                    exportPdfBtn.disabled = false;
                    exportPdfBtn.innerHTML = '<i class="fas fa-file-pdf mr-2"></i>Export PDF Report';
                }
            }

            async function refreshLivePrices() {
                if (!portfolioData || !portfolioData.holdings) return;

                const refreshPricesBtn = document.getElementById('refreshPricesBtn');
                const lastRefreshed = document.getElementById('lastRefreshed');
                const origText = refreshPricesBtn.innerHTML;

                try {
                    refreshPricesBtn.innerHTML = '\u003ci class="fas fa-spinner fa-spin mr-2"\u003e\u003c/i\u003eRefreshing...';
                    refreshPricesBtn.disabled = true;

                    const tickers = portfolioData.holdings.map(h => h.Symbol || h.ticker).filter(Boolean);
                    const freshPrices = await fetchLivePrices(tickers);

                    portfolioData.holdings.forEach(h => {
                        const ticker = h.Symbol || h.ticker;
                        const quote = freshPrices[ticker];
                        if (quote && quote.price) {
                            h['Price ($)'] = quote.price;
                            h.price = quote.price;
                            h.value = h.price * (h.Quantity || h.quantity || 0);
                        }
                    });

                    const now = new Date();
                    lastRefreshed.textContent = 'Last refreshed: ' + now.toLocaleTimeString();

                    // Re-render dashboard parts
                    renderDashboard(portfolioData);
                } catch (err) {
                    console.error('Refresh failed', err);
                    alert('Failed to refresh live prices');
                } finally {
                    refreshPricesBtn.innerHTML = origText;
                    refreshPricesBtn.disabled = false;
                }
            }

            function computeSummaryFromHoldings(holdings) {
                const summary = {
                    total_value: 0,
                    total_principal: 0,
                    total_gain_loss: 0,
                    total_daily_change: 0,
                    overall_return_pct: 0,
                    daily_return_pct: 0,
                    total_annual_income: 0,
                    avg_yield: 0,
                    num_holdings: holdings.length
                };

                holdings.forEach(h => {
                    summary.total_value += h.value || 0;
                    summary.total_principal += h.cost_basis || 0;
                    summary.total_annual_income += h.annual_income || 0;
                    summary.total_daily_change += h.daily_change || 0;
                    summary.total_gain_loss += (h.value || 0) - (h.cost_basis || 0);
                    summary.avg_yield += (h.yield_pct || 0);
                });

                if (holdings.length > 0) {
                    summary.avg_yield = summary.avg_yield / holdings.length;
                    summary.overall_return_pct = summary.total_principal ? (summary.total_gain_loss / summary.total_principal) * 100 : 0;
                    summary.daily_return_pct = summary.total_value ? (summary.total_daily_change / summary.total_value) * 100 : 0;
                }

                return summary;
            }

            function computeChartsFromHoldings(holdings) {
                const allocation_by_symbol = holdings.map(h => ({ Symbol: h.Symbol || h.ticker || '', 'Value ($)': h.value || 0, 'Assets (%)': h.allocation_pct || 0 }));
                const allocation_by_type = buildAllocationByType(holdings);
                const gain_loss_by_symbol = holdings.map(h => ({ Symbol: h.Symbol || h.ticker || '', 'NFS G/L ($)': (h.value || 0) - (h.cost_basis || 0) }));
                const daily_movement = holdings.map(h => ({ Symbol: h.Symbol || h.ticker || '', '1-Day Value Change ($)': h.daily_change || 0 }));

                return { allocation_by_symbol, allocation_by_type, gain_loss_by_symbol, daily_movement };
            }

            function escapeHtml(unsafe) {
                return String(unsafe)
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/\"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }

            function exportToCSV() {
                if (!portfolioData) return;

                const holdings = portfolioData.holdings;
                const headers = Object.keys(holdings[0]);

                let csv = headers.join(',') + '\n';
                holdings.forEach(row => {
                    csv += headers.map(h => `"${row[h]}"`).join(',') + '\n';
                });

                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'portfolio_export.csv';
                a.click();
            }




            // Advanced Analytics Functions
            async function fetchAdvancedAnalytics(file) {
                try {
                    const formData = new FormData();
                    formData.append('file', file);

                    const response = await fetch(`${API_URL}/api/portfolio/analyze`, {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) throw new Error('Analytics fetch failed');

                    const data = await response.json();
                    return data.analytics; // return 'analytics' key which matches main dashboard structure
                } catch (error) {
                    console.error('Failed to fetch advanced analytics:', error);
                    return null;
                }
            }

            // Builder State
            let builderHoldings = [];
            let builderCharts = {};

            // Initialize
            document.addEventListener('DOMContentLoaded', () => {
                setupTabs();
                setupBuilder();
            });

            function setupBuilder() {
                const searchInput = document.getElementById('assetSearch');
                const resultsDiv = document.getElementById('searchResults');
                const simulateBtn = document.getElementById('simulateBtn');
                const searchIcon = document.getElementById('searchIcon');
                const searchSpinner = document.getElementById('searchSpinner');

                // Search Debounce with Loading State
                let timeout = null;
                searchInput.addEventListener('input', (e) => {
                    clearTimeout(timeout);
                    const query = e.target.value.trim();

                    if (query.length < 1) {
                        resultsDiv.classList.add('hidden');
                        searchIcon.classList.remove('hidden');
                        searchSpinner.classList.add('hidden');
                        return;
                    }

                    // Show loading state
                    searchIcon.classList.add('hidden');
                    searchSpinner.classList.remove('hidden');

                    timeout = setTimeout(async () => {
                        try {
                            const response = await fetch(`${API_URL}/api/v2/market/search/${query}`);
                            searchSpinner.classList.add('hidden');
                            searchIcon.classList.remove('hidden');

                            if (!response.ok) throw new Error('Search failed');
                            const data = await response.json();

                            // Handle both array and object responses
                            const results = Array.isArray(data) ? data : (data.results || []);
                            renderSearchResults(results, query);
                        } catch (error) {
                            console.error('Search error:', error);
                            searchSpinner.classList.add('hidden');
                            searchIcon.classList.remove('hidden');
                            resultsDiv.innerHTML = '<div class="p-3 text-sm text-red-500"><i class="fas fa-exclamation-triangle mr-2"></i>Search failed. Try another symbol.</div>';
                            resultsDiv.classList.remove('hidden');
                            Toast.error('Unable to search. Please check your connection.');
                        }
                    }, 500);
                });

                // Enter key support
                searchInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        document.getElementById('manualAddBtn').click();
                    }
                });

                // Simulate Button
                simulateBtn.addEventListener('click', runSimulation);

                // Manual Add Button - Enhanced
                document.getElementById('manualAddBtn').addEventListener('click', async () => {
                    const query = searchInput.value.trim().toUpperCase();
                    if (!query) {
                        Toast.warning('Please enter a stock symbol');
                        searchInput.focus();
                        return;
                    }

                    // Show loading on button
                    const btn = document.getElementById('manualAddBtn');
                    const originalHTML = btn.innerHTML;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                    btn.disabled = true;

                    // Try to fetch data first
                    try {
                        console.log('Fetching stock data for', query);
                        const response = await fetch(`${API_URL}/api/market/search?q=${query}`);
                        console.log('Response status:', response.status);

                        if (response.ok) {
                            const data = await response.json();
                            console.log('API response data:', data);
                            const results = Array.isArray(data) ? data : (data.results || []);

                            if (results.length > 0) {
                                console.log('Adding stock to builder:', results[0]);
                                addToBuilder(results[0], true); // Add with animation
                                btn.innerHTML = originalHTML;
                                btn.disabled = false;
                                return;
                            } else {
                                console.warn('No results found for', query);
                                Toast.info(`No data found for ${query}. Adding as manual entry.`);
                            }
                        } else {
                            console.error('API request failed with status:', response.status);
                            Toast.warning(`Could not fetch data for ${query}. Adding as manual entry.`);
                        }
                    } catch (e) {
                        console.error('Error fetching stock data:', e);
                        Toast.warning(`Error fetching ${query} data. Adding as manual entry.`);
                    }

                    // Fallback: manual entry
                    console.log('Adding as manual entry:', query);
                    addToBuilder({ symbol: query, price: 0, name: 'Manual Entry' }, true);
                    btn.innerHTML = originalHTML;
                    btn.disabled = false;
                });
            }

            function renderSearchResults(results, query = '') {
                const resultsDiv = document.getElementById('searchResults');
                resultsDiv.innerHTML = '';

                if (!results || results.length === 0) {
                    resultsDiv.innerHTML = `
                        <div class="p-4 text-center">
                            <i class="fas fa-search text-2xl text-gray-300 mb-2"></i>
                            <p class="text-sm text-gray-500">No results found for "${query}"</p>
                            <p class="text-xs text-gray-400 mt-1">Try a different symbol</p>
                        </div>
                    `;
                } else {
                    // Add result count header
                    const headerHTML = `
                        <div class="px-3 py-2 bg-gray-50 border-b border-gray-200 flex items-center justify-between">
                            <span class="text-xs font-medium text-gray-600">
                                <i class="fas fa-list mr-1"></i>${results.length} result${results.length > 1 ? 's' : ''}
                            </span>
                            <span class="text-xs text-gray-400">Click to add</span>
                        </div>
                    `;
                    resultsDiv.innerHTML = headerHTML;

                    results.forEach((item, index) => {
                        const div = document.createElement('div');
                        div.className = 'p-3 hover:bg-blue-50 cursor-pointer flex justify-between items-center border-b border-gray-100 last:border-0 transition-colors';
                        div.innerHTML = `
                            <div class="flex-1">
                                <div class="font-bold text-gray-900">${item.symbol}</div>
                                <div class="text-xs text-gray-500 truncate">${item.name || 'Unknown'}</div>
                                ${item.sector ? `<span class="text-xs text-blue-600"><i class="fas fa-industry mr-1"></i>${item.sector}</span>` : ''}
                            </div>
                            <div class="text-right">
                                <div class="text-sm font-medium text-gray-900">$${item.price?.toFixed(2) || '-'}</div>
                                <div class="text-xs text-gray-400">${item.exchange || ''}</div>
                            </div>
                        `;
                        div.onclick = () => {
                            addToBuilder(item, true);
                            resultsDiv.classList.add('hidden');
                        };
                        resultsDiv.appendChild(div);

                        // Stagger animation
                        div.style.animation = `fadeIn 0.2s ease-out ${index * 0.05}s both`;
                    });
                }
                resultsDiv.classList.remove('hidden');
            }

            function addToBuilder(asset, showFeedback = false) {
                // Check if already exists
                if (builderHoldings.find(h => h.symbol === asset.symbol)) {
                    if (showFeedback) {
                        Toast.warning(`${asset.symbol} is already in your portfolio`);
                    }
                    return;
                }

                builderHoldings.push({
                    symbol: asset.symbol,
                    weight: 0, // Default 0
                    price: asset.price,
                    name: asset.name || asset.symbol
                });

                // Show success feedback
                if (showFeedback) {
                    Toast.success(`Added ${asset.symbol} to portfolio`);

                    // Pulse animation on holdings card
                    const card = document.getElementById('holdingsCard');
                    card.classList.add('pulse-success');
                    setTimeout(() => card.classList.remove('pulse-success'), 1000);
                }

                renderBuilderHoldings();
                document.getElementById('assetSearch').value = '';
                document.getElementById('searchResults').classList.add('hidden');
                updateSimulateButton();
                updateHoldingsCount();
            }

            function renderBuilderHoldings() {
                const container = document.getElementById('builderHoldingsList');
                const totalWeightEl = document.getElementById('totalWeight');
                const emptyState = document.getElementById('emptyHoldingsState');

                if (builderHoldings.length === 0) {
                    if (!emptyState) {
                        container.innerHTML = `
                            <div id="emptyHoldingsState" class="text-center py-12">
                                <div class="inline-block p-4 rounded-full bg-gray-100 mb-3">
                                    <i class="fas fa-folder-open text-4xl text-gray-400"></i>
                                </div>
                                <p class="text-gray-500 mb-2">No assets added yet</p>
                                <p class="text-sm text-gray-400">Search for stocks above to start building your portfolio</p>
                            </div>
                        `;
                    } else {
                        emptyState.classList.remove('hidden');
                    }
                    totalWeightEl.textContent = 'Total: 0%';
                    totalWeightEl.className = 'text-sm font-medium text-gray-500';
                    return;
                }

                // Hide empty state
                if (emptyState) {
                    emptyState.classList.add('hidden');
                }

                container.innerHTML = builderHoldings.map((h, index) => `
                    <div class="bg-gradient-to-r from-gray-50 to-white rounded-lg p-4 flex items-center justify-between border border-gray-200 hover:border-blue-300 hover:shadow-sm transition-all group">
                        <div class="flex-1">
                            <div class="flex items-center gap-2">
                                <div class="font-bold text-gray-900 text-lg">${h.symbol}</div>
                                ${h.name && h.name !== h.symbol ? `<span class="text-xs text-gray-400 truncate max-w-[150px]">${h.name}</span>` : ''}
                            </div>
                            <div class="text-sm text-gray-600 mt-1">
                                <i class="fas fa-dollar-sign text-green-600"></i> $${h.price?.toFixed(2) || '-'}
                            </div>
                        </div>
                        <div class="flex items-center space-x-3">
                            <div class="flex flex-col items-end">
                                <label class="text-xs text-gray-500 mb-1">Weight</label>
                                <div class="relative">
                                    <input type="number" 
                                        class="w-24 px-3 py-2 text-right text-sm border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
                                        value="${h.weight}" 
                                        min="0" max="100" step="1"
                                        onchange="updateWeight(${index}, this.value)"
                                        placeholder="0">
                                    <span class="absolute right-3 top-2.5 text-xs text-gray-400 pointer-events-none">%</span>
                                </div>
                            </div>
                            <button onclick="removeFromBuilder(${index})" 
                                class="text-gray-400 hover:text-red-600 hover:bg-red-50 p-2 rounded-lg transition-colors opacity-0 group-hover:opacity-100"
                                title="Remove from portfolio">
                                <i class="fas fa-times text-lg"></i>
                            </button>
                        </div>
                    </div>
                `).join('');

                // Update Total
                const total = builderHoldings.reduce((sum, h) => sum + h.weight, 0);
                totalWeightEl.textContent = `Total: ${total.toFixed(1)}%`;

                if (Math.abs(total - 100) < 0.1) {
                    totalWeightEl.className = 'text-sm font-bold text-green-600 flex items-center gap-1';
                    totalWeightEl.innerHTML = `<i class="fas fa-check-circle"></i> Total: ${total.toFixed(1)}%`;
                } else if (total > 100) {
                    totalWeightEl.className = 'text-sm font-bold text-red-600 flex items-center gap-1';
                    totalWeightEl.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Total: ${total.toFixed(1)}%`;
                } else {
                    totalWeightEl.className = 'text-sm font-bold text-orange-500 flex items-center gap-1';
                    totalWeightEl.innerHTML = `<i class="fas fa-info-circle"></i> Total: ${total.toFixed(1)}%`;
                }
            }

            // Helper function to update holdings count badge
            function updateHoldingsCount() {
                const badge = document.getElementById('holdingsCount');
                if (badge) {
                    badge.textContent = builderHoldings.length;
                    if (builderHoldings.length > 0) {
                        badge.classList.remove('bg-blue-100', 'text-blue-700');
                        badge.classList.add('bg-green-100', 'text-green-700');
                    } else {
                        badge.classList.remove('bg-green-100', 'text-green-700');
                        badge.classList.add('bg-blue-100', 'text-blue-700');
                    }
                }
            }

            window.updateWeight = (index, value) => {
                builderHoldings[index].weight = parseFloat(value) || 0;
                renderBuilderHoldings();
            };

            window.removeFromBuilder = (index) => {
                builderHoldings.splice(index, 1);
                renderBuilderHoldings();
                updateSimulateButton();
            };

            function updateSimulateButton() {
                const btn = document.getElementById('simulateBtn');
                btn.disabled = builderHoldings.length === 0;
            }

            async function runSimulation() {
                const btn = document.getElementById('simulateBtn');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Analyzing...';
                btn.disabled = true;

                try {
                    console.log('Starting portfolio simulation with holdings:', builderHoldings);
                    const response = await fetch(`${API_URL}/api/portfolio/simulate`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ holdings: builderHoldings })
                    });

                    console.log('Simulation response status:', response.status);
                    const data = await response.json();
                    console.log('Simulation response data:', data);

                    if (data.success) {
                        console.log('Rendering simulation results...');
                        renderSimulationResults(data.proposed);
                        Toast.success('Portfolio analysis complete!');
                    } else {
                        console.error('Simulation failed:', data.error);
                        Toast.error('Simulation failed: ' + data.error);
                    }
                } catch (error) {
                    console.error('Simulation error:', error);
                    Toast.error('Error running simulation: ' + error.message);
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            }

            function renderSimulationResults(data) {
                // Update Summary Cards
                document.getElementById('previewReturn').textContent = formatCurrency(data.summary.total_gain_loss); // Using gain as proxy for return value for now, or use total_return %
                // Actually summary has total_return_pct
                document.getElementById('previewReturn').textContent = data.summary.total_return_pct + '%';

                // Risk
                const vol = data.analytics.risk_metrics.volatility;
                document.getElementById('previewRisk').textContent = (vol * 100).toFixed(2) + '%';

                // Yield
                const yieldVal = data.analytics.advanced_risk?.dividend_metrics?.average_yield || 0;
                document.getElementById('previewYield').textContent = data.summary.avg_yield ? data.summary.avg_yield + '%' : '-';

                // Charts
                renderBuilderCharts(data);

                // Risk Stats
                renderRiskStats(data);
            }

            function renderRiskStats(data) {
                const riskContainer = document.getElementById('builderRiskStats');
                const risk = data.analytics.risk_metrics;
                const advRisk = data.analytics.advanced_risk;

                let riskHTML = '<div class="grid grid-cols-2 gap-4">';

                // Volatility
                riskHTML += `
                    <div class="bg-blue-50 rounded-lg p-3">
                        <div class="text-xs text-blue-600 font-medium mb-1">Portfolio Volatility</div>
                        <div class="text-xl font-bold text-blue-900">${risk.portfolio_volatility || 0}%</div>
                    </div>
                `;

                // Value at Risk (95%)
                riskHTML += `
                    <div class="bg-red-50 rounded-lg p-3">
                        <div class="text-xs text-red-600 font-medium mb-1">Value at Risk (95%)</div>
                        <div class="text-xl font-bold text-red-900">$${(risk.value_at_risk_95 || 0).toLocaleString()}</div>
                    </div>
                `;

                // Sharpe Ratio (if available from advanced risk)
                if (advRisk && advRisk.metrics) {
                    riskHTML += `
                        <div class="bg-green-50 rounded-lg p-3">
                            <div class="text-xs text-green-600 font-medium mb-1">Sharpe Ratio</div>
                            <div class="text-xl font-bold text-green-900">${(advRisk.metrics.sharpe || 0).toFixed(2)}</div>
                        </div>
                    `;

                    // Beta
                    riskHTML += `
                        <div class="bg-purple-50 rounded-lg p-3">
                            <div class="text-xs text-purple-600 font-medium mb-1">Beta (vs S&P 500)</div>
                            <div class="text-xl font-bold text-purple-900">${(advRisk.metrics.beta || 0).toFixed(2)}</div>
                        </div>
                    `;
                }

                riskHTML += '</div>';
                riskContainer.innerHTML = riskHTML;
            }

            function renderBuilderCharts(data) {
                // Allocation Chart
                const allocCtx = document.getElementById('builderAllocationChart').getContext('2d');
                if (builderCharts.allocation) builderCharts.allocation.destroy();

                const allocData = data.charts.allocation_by_symbol;
                builderCharts.allocation = new Chart(allocCtx, {
                    type: 'doughnut',
                    data: {
                        labels: allocData.map(d => d.Symbol),
                        datasets: [{
                            data: allocData.map(d => d['Assets (%)']),
                            backgroundColor: [
                                '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6',
                                '#ec4899', '#14b8a6', '#f97316', '#06b6d4', '#84cc16'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'right' } }
                    }
                });

                // Performance Chart (Monte Carlo P50)
                const perfCtx = document.getElementById('builderPreviewChart').getContext('2d');
                if (builderCharts.performance) builderCharts.performance.destroy();

                const mcData = data.analytics.advanced_risk?.monte_carlo;
                if (mcData) {
                    builderCharts.performance = new Chart(perfCtx, {
                        type: 'line',
                        data: {
                            labels: mcData.labels,
                            datasets: [{
                                label: 'Projected Value',
                                data: mcData.p50,
                                borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            elements: { point: { radius: 0 } },
                            scales: {
                                x: { display: false },
                                y: { ticks: { callback: v => '$' + (v / 1000).toFixed(0) + 'k' } }
                            }
                        }
                    });
                }
            }

            function setupTabs() {
                const tabs = document.querySelectorAll('.tab-button'); // Updated selector
                tabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        // Remove active class from all tabs
                        tabs.forEach(t => {
                            t.classList.remove('text-blue-600', 'border-blue-600');
                            t.classList.add('text-gray-500', 'border-transparent');
                        });

                        // Add active class to clicked tab
                        tab.classList.remove('text-gray-500', 'border-transparent');
                        tab.classList.add('text-blue-600', 'border-blue-600');

                        // Hide all content
                        document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));

                        // Show target content
                        const targetId = tab.dataset.tab + '-tab';
                        document.getElementById(targetId).classList.remove('hidden');
                    });
                });
            }

            function setupAnalyticsTabs() {
                const tabs = document.querySelectorAll('.analytics-tab');

                tabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        // Remove active state from all tabs
                        tabs.forEach(t => {
                            t.classList.remove('active', 'border-blue-600', 'text-blue-600');
                            t.classList.add('border-transparent', 'text-gray-500');
                        });

                        // Add active state to clicked tab
                        tab.classList.add('active', 'border-blue-600', 'text-blue-600');
                        tab.classList.remove('border-transparent', 'text-gray-500');

                        // Hide all tab contents
                        document.querySelectorAll('.analytics-tab-content').forEach(content => {
                            content.classList.add('hidden');
                        });

                        // Show selected tab content
                        const tabName = tab.getAttribute('data-tab');
                        document.getElementById(`tab-${tabName}`).classList.remove('hidden');
                    });
                });
            }

            function renderAdvancedAnalytics(analytics) {
                if (!analytics) return;

                // Risk Metrics
                if (analytics.risk_metrics) {
                    document.getElementById('var95').textContent = formatCurrency(analytics.risk_metrics.value_at_risk_95);
                    document.getElementById('volatility').textContent = analytics.risk_metrics.portfolio_volatility.toFixed(2) + '%';
                }

                // Diversification
                if (analytics.diversification) {
                    document.getElementById('diversificationScore').textContent = Math.round(analytics.diversification.score);
                    document.getElementById('concentrationRisk').textContent =
                        `Concentration Risk: ${analytics.diversification.concentration_risk}`;
                }

                // Tax Loss Harvesting
                if (analytics.tax_loss_harvesting && analytics.tax_loss_harvesting.length > 0) {
                    const taxList = document.getElementById('taxList');
                    taxList.innerHTML = analytics.tax_loss_harvesting.slice(0, 5).map(opp => `
                    <div class="mb-2">
                        <strong>${opp.symbol}</strong>: ${formatCurrency(opp.current_loss)} loss 
                        (Est. tax benefit: ${formatCurrency(opp.estimated_tax_benefit)})
                    </div>
                `).join('');
                }

                // Sector Allocation Chart
                if (analytics.sector_allocation && analytics.sector_allocation.sectors) {
                    renderSectorChart(analytics.sector_allocation.sectors);
                }

                // Dividend Metrics
                if (analytics.dividend_metrics) {
                    document.getElementById('monthlyIncome').textContent = formatCurrency(analytics.dividend_metrics.monthly_income);
                    document.getElementById('quarterlyIncome').textContent = formatCurrency(analytics.dividend_metrics.quarterly_income);
                    document.getElementById('dividendCount').textContent = analytics.dividend_metrics.dividend_stocks_count;

                    if (analytics.dividend_metrics.top_dividend_payers) {
                        renderTopDividendPayers(analytics.dividend_metrics.top_dividend_payers);
                    }
                }

                // Performance Scatter Plot
                if (analytics.performance_vs_weight) {
                    renderPerformanceScatter(analytics.performance_vs_weight);
                }

                // Advanced Risk Analytics
                if (analytics.advanced_risk) {
                    if (analytics.advanced_risk.monte_carlo) {
                        renderMonteCarloChart(analytics.advanced_risk.monte_carlo);
                    }
                    if (analytics.advanced_risk.correlation_matrix) {
                        renderCorrelationMatrix(analytics.advanced_risk.correlation_matrix);
                    }
                }
            }

            function renderMonteCarloChart(data) {
                const ctx = document.getElementById('monteCarloChart').getContext('2d');

                if (charts.monteCarlo) {
                    charts.monteCarlo.destroy();
                }

                charts.monteCarlo = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.labels,
                        datasets: [
                            {
                                label: '90th Percentile (Best Case)',
                                data: data.p90,
                                borderColor: 'rgba(16, 185, 129, 1)', // Green
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                borderWidth: 1,
                                fill: false,
                                pointRadius: 0
                            },
                            {
                                label: '50th Percentile (Median)',
                                data: data.p50,
                                borderColor: 'rgba(59, 130, 246, 1)', // Blue
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                borderWidth: 2,
                                fill: false,
                                pointRadius: 0
                            },
                            {
                                label: '10th Percentile (Worst Case)',
                                data: data.p10,
                                borderColor: 'rgba(239, 68, 68, 1)', // Red
                                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                borderWidth: 1,
                                fill: false,
                                pointRadius: 0
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            intersect: false,
                            mode: 'index',
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        return context.dataset.label + ': ' + formatCurrency(context.raw);
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: { display: true, text: 'Trading Days' },
                                grid: { display: false }
                            },
                            y: {
                                title: { display: true, text: 'Portfolio Value ($)' },
                                ticks: {
                                    callback: function (value) { return '$' + (value / 1000).toFixed(0) + 'k'; }
                                }
                            }
                        }
                    }
                });

                // Update stats
                const startVal = data.start_value;
                const endP50 = data.p50[data.p50.length - 1];
                const returnP50 = ((endP50 - startVal) / startVal * 100).toFixed(1);

                const statsHtml = `
                <div class="bg-gray-50 p-2 rounded">
                    <div class="text-xs text-gray-500">Start Value</div>
                    <div class="font-bold">${formatCurrency(startVal)}</div>
                </div>
                <div class="bg-blue-50 p-2 rounded">
                    <div class="text-xs text-gray-500">Proj. Median Value</div>
                    <div class="font-bold text-blue-700">${formatCurrency(endP50)}</div>
                </div>
                <div class="bg-blue-50 p-2 rounded">
                    <div class="text-xs text-gray-500">Proj. Return</div>
                    <div class="font-bold text-blue-700">${returnP50}%</div>
                </div>
            `;
                document.getElementById('monteCarloStats').innerHTML = statsHtml;
            }

            function renderCorrelationMatrix(data) {
                const container = document.getElementById('correlationMatrix');
                const labels = data.labels;
                const values = data.values;

                let html = '<table class="w-full text-xs border-collapse">';

                // Header row
                html += '<thead><tr><th class="p-1"></th>';
                labels.forEach(label => {
                    html += `<th class="p-1 font-bold text-gray-600 rotate-45 origin-bottom-left h-20 align-bottom">${label}</th>`;
                });
                html += '</tr></thead><tbody>';

                // Data rows
                values.forEach((row, i) => {
                    html += `<tr><th class="p-1 font-bold text-gray-600 text-right pr-2">${labels[i]}</th>`;
                    row.forEach(val => {
                        // Color scale: -1 (blue) to 0 (white) to 1 (red)
                        let bgColor;
                        if (val >= 0) {
                            // Red scale for positive correlation
                            const intensity = Math.round(val * 255);
                            bgColor = `rgba(239, 68, 68, ${val * 0.8})`; // Red with opacity
                        } else {
                            // Blue scale for negative correlation
                            const intensity = Math.round(Math.abs(val) * 255);
                            bgColor = `rgba(59, 130, 246, ${Math.abs(val) * 0.8})`; // Blue with opacity
                        }

                        const textColor = Math.abs(val) > 0.5 ? 'white' : 'black';

                        html += `<td class="p-2 text-center border border-gray-100" style="background-color: ${bgColor}; color: ${textColor}">
                        ${val.toFixed(2)}
                    </td>`;
                    });
                    html += '</tr>';
                });

                html += '</tbody></table>';
                container.innerHTML = html;
            }

            function renderPerformanceScatter(data) {
                const ctx = document.getElementById('performanceScatterChart').getContext('2d');

                // Destroy existing chart if it exists
                if (charts.performanceScatter) {
                    charts.performanceScatter.destroy();
                }

                const points = data.points.map(p => ({
                    x: p['Assets (%)'],
                    y: p['Total Return (%)'],
                    symbol: p.Symbol
                }));

                const trendline = data.trendline ? data.trendline : [];

                charts.performanceScatter = new Chart(ctx, {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: 'Holdings',
                            data: points,
                            backgroundColor: 'rgba(37, 99, 235, 0.6)',
                            borderColor: 'rgba(37, 99, 235, 1)',
                            borderWidth: 1,
                            pointRadius: 6,
                            pointHoverRadius: 8
                        }, {
                            type: 'line',
                            label: 'Trend Line',
                            data: trendline,
                            borderColor: 'rgba(107, 114, 128, 0.8)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            fill: false,
                            pointRadius: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        const point = context.raw;
                                        if (context.dataset.type === 'line') return null;
                                        return `${point.symbol}: Weight ${point.x.toFixed(2)}%, Return ${point.y.toFixed(2)}%`;
                                    }
                                }
                            },
                            annotation: {
                                annotations: {
                                    line1: {
                                        type: 'line',
                                        yMin: 0,
                                        yMax: 0,
                                        borderColor: 'rgba(0,0,0,0.2)',
                                        borderWidth: 1
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Portfolio Weight (%)'
                                },
                                grid: {
                                    display: false
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Total Return (%)'
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            }
                        }
                    }
                });

                // Update stats
                if (data.stats) {
                    const statsHtml = `
                    <div class="bg-blue-50 p-3 rounded-lg">
                        <div class="text-xs text-gray-500 uppercase">Slope</div>
                        <div class="text-lg font-bold text-blue-700">${data.stats.slope}</div>
                    </div>
                    <div class="bg-green-50 p-3 rounded-lg">
                        <div class="text-xs text-gray-500 uppercase">R-Squared</div>
                        <div class="text-lg font-bold text-green-700">${data.stats.r_squared}</div>
                    </div>
                    <div class="bg-purple-50 p-3 rounded-lg">
                        <div class="text-xs text-gray-500 uppercase">Intercept</div>
                        <div class="text-lg font-bold text-purple-700">${data.stats.intercept}</div>
                    </div>
                `;
                    document.getElementById('performanceStats').innerHTML = statsHtml;
                }
            }

            function renderSectorChart(sectors) {
                const ctx = document.getElementById('sectorAllocationChart').getContext('2d');

                if (charts.sectorAllocation) {
                    charts.sectorAllocation.destroy();
                }

                charts.sectorAllocation = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: sectors.map(s => s['Asset Type']),
                        datasets: [{
                            data: sectors.map(s => s['Value ($)']),
                            backgroundColor: generateColors(sectors.length)
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'right' },
                            tooltip: {
                                callbacks: {
                                    label: (context) => {
                                        const label = context.label || '';
                                        const value = formatCurrency(context.parsed);
                                        return `${label}: ${value}`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            function renderTopDividendPayers(payers) {
                const container = document.getElementById('topDividendPayers');
                container.innerHTML = `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase">Symbol</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase">Description</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-700 uppercase">Annual Income</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-700 uppercase">Yield %</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        ${payers.map(p => `
                            <tr class="hover:bg-gray-50">
                                <td class="px-4 py-3 font-semibold text-gray-900">${p.Symbol}</td>
                                <td class="px-4 py-3 text-gray-700">${p.Description || ''}</td>
                                <td class="px-4 py-3 text-right font-semibold text-green-600">${formatCurrency(p['Est Annual Income ($)'])}</td>
                                <td class="px-4 py-3 text-right text-gray-700">${p['Current Yld/Dist Rate (%)'].toFixed(2)}%</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            }


            async function handleAddAsset(e) {
                e.preventDefault();
                if (!currentPortfolioId) {
                    alert('No portfolio loaded. Please save or load a portfolio first.');
                    return;
                }

                const type = document.getElementById('assetTypeInput').value;
                const ticker = document.getElementById('assetTickerInput').value;
                const qty = parseFloat(document.getElementById('assetQtyInput').value);
                const price = parseFloat(document.getElementById('assetPriceInput').value);
                const cost = parseFloat(document.getElementById('assetCostInput').value) || (qty * price);

                const payload = {
                    ticker: ticker,
                    quantity: qty,
                    price: price,
                    cost_basis: cost,
                    asset_type: type,
                    currency: 'USD',
                    metadata: { added_manually: true }
                };

                try {
                    const res = await fetch(`${API_URL}/api/v2/portfolio/${currentPortfolioId}/holdings`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!res.ok) throw new Error('Failed to add asset');

                    // Success
                    document.getElementById('addAssetModal').classList.add('hidden');
                    document.getElementById('addAssetForm').reset();

                    // Reload portfolio
                    await loadPortfolio(currentPortfolioId, false); // Don't fetch live prices immediately to be faster
                    updateWealthMetrics(); // Refresh wealth cards too

                } catch (err) {
                    alert('Error adding asset: ' + err.message);
                }
            }

            // Utility functions
            function formatCurrency(value) {
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD',
                    minimumFractionDigits: 2
                }).format(value);
            }

            function generateColors(count) {
                const colors = [
                    '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6',
                    '#ec4899', '#14b8a6', '#f97316', '#06b6d4', '#84cc16'
                ];

                const result = [];
                for (let i = 0; i < count; i++) {
                    result.push(colors[i % colors.length]);
                }
                return result;
            }
        </script>
</body>

</html>